---
title: "CALICO Aim 2 Analyses"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
editor: source
---

```{r setup}
#| include: false
library(Hmisc)
library(tidyverse)
library(arsenal)
library(lmerTest)
library(performance)
library(emmeans)
library(ggeffects)
library(gtsummary)
library(gt)
home_dir <- switch(Sys.info()["sysname"],
  "Darwin" = "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/BDC/Janet Snell-Bergeon/CALICO",
  "Linux" = "/home/timvigers/OneDrive/Vigers/BDC/Janet Snell-Bergeon/CALICO"
)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
# Load data
load("./Data_Clean/analysis_data.RData")
# Combine factor levels
levels(df$insur_type) <- c(
  "Public", "Private", "Military", "Other/None", "Other/None"
)
df$insur_type <- relevel(df$insur_type, ref = "Private")
levels(df$combined_race) <- c(
  "African American", "Other", "Asian", "Caucasian", "More than one", "Other",
  "Other"
)
df$combined_race <- relevel(df$combined_race, ref = "Caucasian")
# Write a function to determine which visits to include
visits_exclude <- function(data = d, column, remove_all_after = F) {
  # To dataframe
  data <- as.data.frame(data)
  # Yes and no run lengths, and the length of time between
  r <- rle(as.character(data[, column]))
  r <- data.frame(value = r$values, length = r$lengths)
  # Get the end
  r$end <- cumsum(r$length)
  # Get the start
  r$start <- r$end - r$length + 1
  # Length of time between start and end
  r$months <- as.numeric(data$cv_monthssincepcosdx[r$end] -
    data$cv_monthssincepcosdx[r$start])
  # If they only have one unique value, don't remove anything
  if (nrow(r) == 1) {
    data$remove <- NA
  } else if (r$value[1] == "Yes") {
    # If they start as "Yes" remove everything after first "No"
    data$remove[r$start[2]:nrow(data)] <- "Remove"
  } else if (r$value[1] == "No") {
    # If they start a medication after diagnosis, check that they are on it
    # for at least 3 months
    first_yes <- which(r$value == "Yes" & r$months > 3)[1]
    if (is.na(first_yes) & any(r$value == "Yes" & (r$end > r$start))) {
      # If there is no 3 month stretch, but there are consecutive visits, remove
      # everything after the first "Yes"
      data$remove[r$start[2]:nrow(data)] <- "Remove"
    } else if (is.na(first_yes) & !any(r$value == "Yes" & (r$end > r$start))) {
      data$remove <- NA
    } else if (r$end[first_yes] == nrow(data)) {
      # If the first stretch of "yes" values doesn't end, don't exclude anything
      data$remove <- NA
    } else {
      # Otherwise remove anything after the end of the first "Yes" stretch
      data$remove[(r$end[first_yes] + 1):nrow(data)] <- "Remove"
    }
    # Remove any visits with a "Yes" singleton
    data$remove[r[r$value == "Yes" & r$length == 1, "start"]] <- "Remove"
  }
  # Some meds, like progesterone, need to be removed completely after the first
  # yes
  if (remove_all_after) {
    data$remove <- NA
    if ("Yes" %in% r$value) {
      first_yes <- which(r$value == "Yes")[1]
      data$remove[r$start[first_yes]:nrow(data)] <- "Remove"
    }
  }
  # Return
  return(data$remove)
}
# This is probably not the most elegant approach, but it seems to work.
dfs <- split(data.frame(df), df$record_number)
dfs <- lapply(dfs, function(d) {
  # Get removal vector for each med
  d$ec_remove <- visits_exclude(d, "ec")
  d$metformin_remove <- visits_exclude(d, "metformin")
  d$lifestyle_remove <- visits_exclude(d, "lifestyle")
  d$progesterone_remove <- visits_exclude(d, "progesterone", remove_all_after = T)
  d$weight_loss_remove <- visits_exclude(d, "weight_loss", remove_all_after = T)
  # Return new dataframe for combining later
  return(d)
})
df <- do.call(rbind, dfs)
# Get baseline weight and BMI
df <- df %>%
  arrange(record_number, cv_monthssincepcosdx) %>%
  group_by(record_number) %>%
  mutate(
    baseline_weight = first(cv_weight, na_rm = T),
    baseline_bmi = first(cv_bmi, na_rm = T)
  )
# For weight loss medication and progesterone, remove all visits after
# they first start
df <- df %>% filter(is.na(weight_loss_remove), is.na(progesterone_remove))
# Additional labels
label(df$combined_race) <- "Race"
label(df$ethnicity) <- "Ethnicity"
label(df$insur_type) <- "Insurance Type"
label(df$ec) <- "On Estrogen-Containing Medication?"
label(df$metformin) <- "On Metformin?"
label(df$lifestyle) <- "On Lifestyle Medicine?"
label(df$weight_loss) <- "On Weight Loss Medication?"
label(df$progesterone) <- "On Progesterone-Containing Medication?"
# Stratify by weight group
# df <- df %>% filter(weight_cat == "Normal weight")
```

# Data cleaning

- Tim will update this section.

# Methods

For each continuous outcome, we fit a linear mixed effects model with random intercept for participant and random slope for time if possible (if the random slope model did not converge we used just the random intercept), and an interaction effect between time and medication status. 

To evaluate the effect of starting a new medication on each outcome, we also fit a linear spline model with months from medication start as the time variable and a single knot at 0 (medication start). For the spline analysis, we limited the dataset to people who were on a given medication at some point. We also limited the "before" medication data to observations within 12 months prior to medication start.

All models were adjusted for race, insurance status at diagnosis, age at clinic visit, and spironolactone use. EC models were adjusted for Metformin use, and vice versa.

Analyses were stratified by weight category at first visit. If BMI percentile was available, < 85 was considered normal weight, >= 85 and < 95 was considered overweight, and >= 95 was considered obese. If percentile was not available, a raw BMI of < 25 was considered normal weight, >= 25 and < 30 was considered overweight, and >= 30 was considered obese.

All mixed models were fit using the `lme4` R package in version `r paste0(R.version$major,".",R.version$minor)`. @rcoreteamLanguageEnvironmentStatistical2024

# Estrogen-containing medication

Participants were considered to be on estrogen-containing (EC) medications when `cv_medications___5` (estrogen-containing pill), `cv_medications___6` (estrogen-containing patch), or `cv_medications___7` (estrogen-containing ring) boxes were checked in REDCap.

```{r}
# Create the EC dataset
ec_df <- df %>%
  filter(is.na(ec_remove)) %>%
  mutate(
    time_of_first_ec = first(cv_monthssincepcosdx[ec == "Yes"], na_rm = T),
    time_from_first_ec = cv_monthssincepcosdx - time_of_first_ec
  ) %>%
  select(
    record_number, combined_race, ethnicity, insur_type, baseline_weight,
    baseline_bmi, cv_age, cv_monthssincepcosdx, time_from_first_ec, ec,
    metformin, cv_medications___16, cv_weight, cv_bmi, cv_a1c, cv_tg, cv_hdl,
    cv_alt, cv_sbp, weight_cat
  )
# Create a spline model dataset
ec_12_month_spline <- ec_df %>%
  filter(time_from_first_ec >= -12) %>%
  mutate(x = (time_from_first_ec > 0) * time_from_first_ec)
label(ec_df$time_from_first_ec) <- "Months from First Visit on EC"
label(ec_12_month_spline$x) <- "Change in Slope After EC Start"
# Write for Melanie and Grayson to check
write.csv(ec_df,
  file = "./Data_Clean/ec_data.csv", row.names = F, na = ""
)
write.csv(ec_12_month_spline,
  file = "./Data_Clean/ec_12_month_spline.csv", row.names = F, na = ""
)
```

## Participant characteristics at earliest visit

Some participants do not have a diagnostic visit entered in REDCap (e.g. BCH8), in which case their earliest visit is reported below instead.

### By medication status

```{r results='asis'}
t1_df <- ec_df %>%
  group_by(record_number) %>%
  mutate(ec_ever = any(ec == "Yes")) %>%
  slice_min(cv_monthssincepcosdx)
t1_df$ec_ever <- factor(t1_df$ec_ever,
  levels = c(F, T),
  labels = c("Never on EC", "Ever on EC")
)
t1 <- tableby(
  ec_ever ~ cv_age + combined_race + ethnicity + fe(insur_type) + cv_weight +
    cv_bmi + cv_a1c + cv_tg + cv_hdl + cv_alt + cv_sbp + cv_monthssincepcosdx,
  data = t1_df
)
summary(t1, pfootnote = T)
```

### By BMI percentile

```{r results='asis'}
t1 <- tableby(
  weight_cat ~ cv_age + combined_race + ethnicity + fe(insur_type) + cv_weight +
    cv_bmi + cv_a1c + cv_tg + cv_hdl + cv_alt + cv_sbp + cv_monthssincepcosdx,
  data = t1_df
)
summary(t1, pfootnote = T)
```

## Weight (kg)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * ec + cv_age + baseline_weight +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
p + theme_bw(base_size = 15) + labs(color = "On EC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_weight ~ time_from_first_ec + x + baseline_weight +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_weight <- mean(mod_df$baseline_weight)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("Weight (kg)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## BMI (kg/m2)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * ec + cv_age + baseline_bmi +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
p + theme_bw(base_size = 15) + labs(color = "On EC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_bmi ~ time_from_first_ec + x + baseline_bmi +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_bmi <- mean(mod_df$baseline_bmi)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("BMI (kg/m2)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## HbA1c (%)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
p + theme_bw(base_size = 15) + labs(color = "On EC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_a1c ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HbA1c (%)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
p + theme_bw(base_size = 15) + labs(color = "On EC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_tg ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("TG (mg/dL)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
p + theme_bw(base_size = 15) + labs(color = "On EC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_hdl ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HDL (mg/dL)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## ALT (IU/L)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
p + theme_bw(base_size = 15) + labs(color = "On EC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_alt ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("ALT (IU/L)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
p + theme_bw(base_size = 15) + labs(color = "On EC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_sbp ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("SBP (mmHg)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

# Metformin

```{r}
# Create the Metformin dataset
metformin_df <- df %>%
  filter(is.na(metformin_remove)) %>%
  mutate(
    time_of_first_metformin = first(cv_monthssincepcosdx[metformin == "Yes"], na_rm = T),
    time_from_first_metformin = cv_monthssincepcosdx - time_of_first_metformin
  ) %>%
  select(
    record_number, combined_race, ethnicity, insur_type, baseline_weight,
    baseline_bmi, cv_age, cv_monthssincepcosdx, time_from_first_metformin, metformin,
    ec, cv_medications___16, cv_weight, cv_bmi, cv_a1c, cv_tg, cv_hdl,
    cv_alt, cv_sbp, weight_cat
  )
# Create a spline model dataset
metformin_12_month_spline <- metformin_df %>%
  filter(time_from_first_metformin >= -12) %>%
  mutate(x = (time_from_first_metformin > 0) * time_from_first_metformin)
label(metformin_df$time_from_first_metformin) <- "Months from First Visit on Metformin"
label(metformin_12_month_spline$x) <- "Change in Slope After Metformin Start"
# Write for Melanie and Grayson to check
write.csv(metformin_df,
  file = "./Data_Clean/metformin_data.csv", row.names = F, na = ""
)
write.csv(metformin_12_month_spline,
  file = "./Data_Clean/metformin_12_month_spline.csv", row.names = F, na = ""
)
```

## Participant characteristics at earliest visit

Some participants do not have a diagnostic visit entered in REDCap (e.g. BCH8), in which case their earliest visit is reported below instead.

### By medication status

```{r results='asis'}
t1_df <- metformin_df %>%
  group_by(record_number) %>%
  mutate(metformin_ever = any(metformin == "Yes")) %>%
  slice_min(cv_monthssincepcosdx)
t1_df$metformin_ever <- factor(t1_df$metformin_ever,
  levels = c(F, T),
  labels = c("Never on Metformin", "Ever on Metformin")
)
t1 <- tableby(
  metformin_ever ~ cv_age + combined_race + ethnicity + fe(insur_type) + cv_weight +
    cv_bmi + cv_a1c + cv_tg + cv_hdl + cv_alt + cv_sbp + cv_monthssincepcosdx,
  data = t1_df
)
summary(t1, pfootnote = T)
```

### By BMI percentile

```{r results='asis'}
t1 <- tableby(
  weight_cat ~ cv_age + combined_race + ethnicity + fe(insur_type) + cv_weight +
    cv_bmi + cv_a1c + cv_tg + cv_hdl + cv_alt + cv_sbp + cv_monthssincepcosdx,
  data = t1_df
)
summary(t1, pfootnote = T)
```

## Weight (kg)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * metformin + cv_age + baseline_weight +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
p + theme_bw(base_size = 15) + labs(color = "On Metformin?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_weight ~ time_from_first_metformin + x + baseline_weight +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_weight <- mean(mod_df$baseline_weight)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("Weight (kg)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## BMI (kg/m2)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * metformin + cv_age + baseline_bmi +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
p + theme_bw(base_size = 15) + labs(color = "On Metformin?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_bmi ~ time_from_first_metformin + x + baseline_bmi +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_bmi <- mean(mod_df$baseline_bmi)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("BMI (kg/m2)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## HbA1c (%)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
p + theme_bw(base_size = 15) + labs(color = "On Metformin?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_a1c ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HbA1c (%)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
p + theme_bw(base_size = 15) + labs(color = "On Metformin?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_tg ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("TG (mg/dL)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
p + theme_bw(base_size = 15) + labs(color = "On Metformin?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_hdl ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HDL (mg/dL)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## ALT (IU/L)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
p + theme_bw(base_size = 15) + labs(color = "On Metformin?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_alt ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("ALT (IU/L)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
p + theme_bw(base_size = 15) + labs(color = "On Metformin?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_sbp ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("SBP (mmHg)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

# Lifestyle

```{r}
# Create the Lifestyle dataset
lifestyle_df <- df %>%
  filter(is.na(lifestyle_remove)) %>%
  mutate(
    time_of_first_lifestyle = first(cv_monthssincepcosdx[lifestyle == "Yes"], na_rm = T),
    time_from_first_lifestyle = cv_monthssincepcosdx - time_of_first_lifestyle
  ) %>%
  select(
    record_number, combined_race, ethnicity, insur_type, baseline_weight,
    baseline_bmi, cv_age, cv_monthssincepcosdx, time_from_first_lifestyle, lifestyle,
    ec, cv_medications___16, cv_weight, cv_bmi, cv_a1c, cv_tg, cv_hdl,
    cv_alt, cv_sbp, weight_cat
  )
# Create a spline model dataset
lifestyle_12_month_spline <- lifestyle_df %>%
  filter(time_from_first_lifestyle >= -12) %>%
  mutate(x = (time_from_first_lifestyle > 0) * time_from_first_lifestyle)
label(lifestyle_df$time_from_first_lifestyle) <- "Months from First Visit on Lifestyle"
label(lifestyle_12_month_spline$x) <- "Change in Slope After Lifestyle Start"
# Write for Melanie and Grayson to check
write.csv(lifestyle_df,
  file = "./Data_Clean/lifestyle_data.csv", row.names = F, na = ""
)
write.csv(lifestyle_12_month_spline,
  file = "./Data_Clean/lifestyle_12_month_spline.csv", row.names = F, na = ""
)
```

## Participant characteristics at earliest visit

Some participants do not have a diagnostic visit entered in REDCap (e.g. BCH8), in which case their earliest visit is reported below instead.

### By medication status

```{r results='asis'}
t1_df <- lifestyle_df %>%
  group_by(record_number) %>%
  mutate(lifestyle_ever = any(lifestyle == "Yes")) %>%
  slice_min(cv_monthssincepcosdx)
t1_df$lifestyle_ever <- factor(t1_df$lifestyle_ever,
  levels = c(F, T),
  labels = c("Never on Lifestyle", "Ever on Lifestyle")
)
t1 <- tableby(
  lifestyle_ever ~ cv_age + combined_race + ethnicity + fe(insur_type) + cv_weight +
    cv_bmi + cv_a1c + cv_tg + cv_hdl + cv_alt + cv_sbp + cv_monthssincepcosdx,
  data = t1_df
)
summary(t1, pfootnote = T)
```

### By BMI percentile

```{r results='asis'}
t1 <- tableby(
  weight_cat ~ cv_age + combined_race + ethnicity + fe(insur_type) + cv_weight +
    cv_bmi + cv_a1c + cv_tg + cv_hdl + cv_alt + cv_sbp + cv_monthssincepcosdx,
  data = t1_df
)
summary(t1, pfootnote = T)
```

## Weight (kg)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * lifestyle + cv_age + baseline_weight +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
p + theme_bw(base_size = 15) + labs(color = "On Lifestyle?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_weight ~ time_from_first_lifestyle + x + baseline_weight +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_weight <- mean(mod_df$baseline_weight)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("Weight (kg)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## BMI (kg/m2)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * lifestyle + cv_age + baseline_bmi +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
p + theme_bw(base_size = 15) + labs(color = "On Lifestyle?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_bmi ~ time_from_first_lifestyle + x + baseline_bmi +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_bmi <- mean(mod_df$baseline_bmi)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("BMI (kg/m2)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## HbA1c (%)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
p + theme_bw(base_size = 15) + labs(color = "On Lifestyle?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_a1c ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HbA1c (%)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
p + theme_bw(base_size = 15) + labs(color = "On Lifestyle?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_tg ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("TG (mg/dL)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
p + theme_bw(base_size = 15) + labs(color = "On Lifestyle?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_hdl ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HDL (mg/dL)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## ALT (IU/L)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
p + theme_bw(base_size = 15) + labs(color = "On Lifestyle?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_alt ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("ALT (IU/L)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
p + theme_bw(base_size = 15) + labs(color = "On Lifestyle?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_sbp ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("SBP (mmHg)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

# LARC

- For the analyses below, we changed the definition of progesterone medication to either `cv_medications___9` or `cv_medications___12` being checked.

```{r}
# Data cleaning is a little different for LARC because we obviously don't
# exclude all progesterone meds
# Load data
load("./Data_Clean/analysis_data.RData")
# Combine factor levels
levels(df$insur_type) <- c(
  "Public", "Private", "Military", "Other/None", "Other/None"
)
df$insur_type <- relevel(df$insur_type, ref = "Private")
levels(df$combined_race) <- c(
  "African American", "Other", "Asian", "Caucasian", "More than one", "Other",
  "Other"
)
df$combined_race <- relevel(df$combined_race, ref = "Caucasian")
# New progesterone variable
df$progesterone <-
  df$cv_medications___9 == "Checked" | df$cv_medications___12 == "Checked"
df$progesterone <-
  factor(df$progesterone, levels = c(F, T), labels = c("No", "Yes"))
# This is probably not the most elegant approach, but it seems to work.
dfs <- split(data.frame(df), df$record_number)
dfs <- lapply(dfs, function(d) {
  # Get removal vector for each med
  d$ec_remove <- visits_exclude(d, "ec")
  d$metformin_remove <- visits_exclude(d, "metformin")
  d$lifestyle_remove <- visits_exclude(d, "lifestyle")
  d$larc_remove <- visits_exclude(d, "larc")
  d$progesterone_remove <- visits_exclude(d, "progesterone", remove_all_after = T)
  d$weight_loss_remove <- visits_exclude(d, "weight_loss", remove_all_after = T)
  # Return new dataframe for combining later
  return(d)
})
df <- do.call(rbind, dfs)
# Get baseline weight and BMI
df <- df %>%
  arrange(record_number, cv_monthssincepcosdx) %>%
  group_by(record_number) %>%
  mutate(
    baseline_weight = first(cv_weight, na_rm = T),
    baseline_bmi = first(cv_bmi, na_rm = T)
  )
# For weight loss medication and progesterone, remove all visits after
# they first start
df <- df %>% filter(is.na(weight_loss_remove), is.na(progesterone_remove))
# Additional labels
label(df$combined_race) <- "Race"
label(df$ethnicity) <- "Ethnicity"
label(df$insur_type) <- "Insurance Type"
label(df$ec) <- "On Estrogen-Containing Medication?"
label(df$metformin) <- "On Metformin?"
label(df$lifestyle) <- "On Lifestyle Medicine?"
label(df$larc) <- "On LARC?"
label(df$weight_loss) <- "On Weight Loss Medication?"
label(df$progesterone) <- "On Progesterone-Containing Medication?"
# Stratify by weight group
# df <- df %>% filter(weight_cat == "Normal weight")
# Create the LARC dataset
larc_df <- df %>%
  filter(is.na(larc_remove)) %>%
  mutate(
    time_of_first_larc = first(cv_monthssincepcosdx[larc == "Yes"], na_rm = T),
    time_from_first_larc = cv_monthssincepcosdx - time_of_first_larc
  ) %>%
  select(
    record_number, combined_race, ethnicity, insur_type, baseline_weight,
    baseline_bmi, cv_age, cv_monthssincepcosdx, time_from_first_larc, larc,
    cv_medications___16, cv_weight, cv_bmi, cv_a1c, cv_tg, cv_hdl,
    cv_alt, cv_sbp, weight_cat
  )
# Create a spline model dataset
larc_12_month_spline <- larc_df %>%
  filter(time_from_first_larc >= -12) %>%
  mutate(x = (time_from_first_larc > 0) * time_from_first_larc)
label(larc_df$time_from_first_larc) <- "Months from First Visit on LARC"
label(larc_12_month_spline$x) <- "Change in Slope After LARC Start"
# Write for Melanie and Grayson to check
write.csv(larc_df,
  file = "./Data_Clean/larc_data.csv", row.names = F, na = ""
)
write.csv(larc_12_month_spline,
  file = "./Data_Clean/larc_12_month_spline.csv", row.names = F, na = ""
)
```

## Participant characteristics at earliest visit

Some participants do not have a diagnostic visit entered in REDCap (e.g. BCH8), in which case their earliest visit is reported below instead.

### By medication status

```{r results='asis'}
t1_df <- larc_df %>%
  group_by(record_number) %>%
  mutate(larc_ever = any(larc == "Yes")) %>%
  slice_min(cv_monthssincepcosdx)
t1_df$larc_ever <- factor(t1_df$larc_ever,
  levels = c(F, T),
  labels = c("Never on LARC", "Ever on LARC")
)
t1 <- tableby(
  larc_ever ~ cv_age + combined_race + ethnicity + fe(insur_type) + cv_weight +
    cv_bmi + cv_a1c + cv_tg + cv_hdl + cv_alt + cv_sbp + cv_monthssincepcosdx,
  data = t1_df
)
summary(t1, pfootnote = T)
```

### By BMI percentile

```{r results='asis'}
t1 <- tableby(
  weight_cat ~ cv_age + combined_race + ethnicity + fe(insur_type) + cv_weight +
    cv_bmi + cv_a1c + cv_tg + cv_hdl + cv_alt + cv_sbp + cv_monthssincepcosdx,
  data = t1_df
)
summary(t1, pfootnote = T)
```

## Weight (kg)

### LARC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * larc + cv_age + baseline_weight +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = larc_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc")))
p + theme_bw(base_size = 15) + labs(color = "On LARC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant.

### Change pre- vs. post-LARC (LARC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_weight ~ time_from_first_larc + x + baseline_weight +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = larc_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_weight <- mean(mod_df$baseline_weight)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_larc)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("Weight (kg)") +
  xlab("Months From LARC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication.

## BMI (kg/m2)

### LARC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * larc + cv_age + baseline_bmi +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = larc_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc")))
p + theme_bw(base_size = 15) + labs(color = "On LARC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant.

### Change pre- vs. post-LARC (LARC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_bmi ~ time_from_first_larc + x + baseline_bmi +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = larc_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_bmi <- mean(mod_df$baseline_bmi)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_larc)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("BMI (kg/m2)") +
  xlab("Months From LARC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication.

## HbA1c (%)

### LARC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * larc + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = larc_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc")))
p + theme_bw(base_size = 15) + labs(color = "On LARC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant.

### Change pre- vs. post-LARC (LARC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_a1c ~ time_from_first_larc + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = larc_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_larc)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HbA1c (%)") +
  xlab("Months From LARC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### LARC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * larc + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = larc_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc")))
p + theme_bw(base_size = 15) + labs(color = "On LARC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant.

### Change pre- vs. post-LARC (LARC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_tg ~ time_from_first_larc + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = larc_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_larc)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("TG (mg/dL)") +
  xlab("Months From LARC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### LARC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * larc + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = larc_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc")))
p + theme_bw(base_size = 15) + labs(color = "On LARC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant.

### Change pre- vs. post-LARC (LARC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_hdl ~ time_from_first_larc + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = larc_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_larc)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HDL (mg/dL)") +
  xlab("Months From LARC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication.

## ALT (IU/L)

### LARC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * larc + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = larc_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc")))
p + theme_bw(base_size = 15) + labs(color = "On LARC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant.

### Change pre- vs. post-LARC (LARC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_alt ~ time_from_first_larc + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = larc_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_larc)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("ALT (IU/L)") +
  xlab("Months From LARC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### LARC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * larc + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = larc_df
)
# Model plot
p <- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc")))
p + theme_bw(base_size = 15) + labs(color = "On LARC?")
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx", pbkrtest.limit = 1e6)
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant.

### Change pre- vs. post-LARC (LARC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_sbp ~ time_from_first_larc + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = larc_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_larc)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("SBP (mmHg)") +
  xlab("Months From LARC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication.
