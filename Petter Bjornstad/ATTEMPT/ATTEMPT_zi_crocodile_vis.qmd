---
title: "ATTEMPT CROCODILE comparison nebula visualization"
author: "Ye Ji Choi"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    code-fold: true
    embed-resources: true
---

```{r echo = F, include = F}
library(dplyr)
library(kableExtra)
library(knitr)
library(ggplot2)
library(purrr)
library(tidyr)
library(stats)
library(patchwork)
library(UpSetR)
library(readxl)
library(fgsea)
library(ReactomeGSA)
library(GSEABase)
library(enrichplot)
library(enrichR)
library(ggrepel)
library(forcats)
library(stringr)
```

```{r echo = F, include = F}
dbs <- c("GO_Biological_Process_2023", 
         "KEGG_2021_Human",
         "Reactome_2022", 
         "Reactome_Pathways_2024")

# function to get precise p-value for large df in volcano plots
safe_pval <- function(t_stat, df, digits = 30) {
  logpt <- pt(q = abs(t_stat), df - 2, log.p = TRUE)
  explogpt <- exp(logpt)
  2*(1-as.numeric(sprintf(paste0("%.", digits, "e"), explogpt)))
}

# function for GSEA
# Set relevant paths
list.files()
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA/"

# Functions ===================================================
## Function: Adjacency matrix to list -------------------------
matrix_to_list <- function(pws){
  pws.l <- list()
  for (pw in colnames(pws)) {
    pws.l[[pw]] <- rownames(pws)[as.logical(pws[, pw])]
  }
  return(pws.l)
}

## Function: prepare_gmt --------------------------------------
prepare_gmt <- function(gmt_file, genes_in_data, savefile = FALSE){

  # Read in gmt file
  gmt <- gmtPathways(gmt_file)
  hidden <- unique(unlist(gmt))
  
  # Convert gmt file to a matrix with the genes as rows and for each go annotation (columns) the values are 0 or 1
  mat <- matrix(NA, dimnames = list(hidden, names(gmt)),
                nrow = length(hidden), ncol = length(gmt))
  for (i in 1:dim(mat)[2]){
    mat[,i] <- as.numeric(hidden %in% gmt[[i]])
  }
  
  #Subset to the genes that are present in our data to avoid bias
  hidden1 <- intersect(genes_in_data, hidden)
  mat <- mat[hidden1, colnames(mat)[which(colSums(mat[hidden1,])>5)]] # filter for gene sets with more than 5 genes annotated
  # And get the list again
  final_list <- matrix_to_list(mat) # for this we use the function we previously defined
  
  if(savefile){
    saveRDS(final_list, file = paste0(gsub('.gmt', '', gmt_file), '_subset_', format(Sys.time(), '%d%m'), '.RData'))
  }
  
  print('Wohoo! .gmt conversion successfull!:)')
  return(final_list)
}

# Download gene sets .gmt files
#https://www.gsea-msigdb.org/gsea/msigdb/collections.jsp
```
#### Volcano plots

```{r echo = F}
plot_volcano <- function(data, fc, p_col, title_suffix, x_axis, y_axis, file_suffix, p_thresh = 0.05) {
  top_pos <- data %>%
    dplyr::filter(!!sym(fc) > 0 & !!sym(p_col) < p_thresh) %>%
    dplyr::arrange(!!sym(p_col)) %>%
    slice_head(n=20)

  top_neg <- data %>%
    dplyr::filter(!!sym(fc) < 0 & !!sym(p_col) < p_thresh) %>%
    dplyr::arrange(!!sym(p_col)) %>%
    slice_head(n=20)

  data <- data %>%
    dplyr::mutate(top_color = case_when(Gene %in% top_pos$Gene ~ "#f28482",
                                 Gene %in% top_neg$Gene ~ "#457b9d",
                                 TRUE ~ "#ced4da"),
           top_size = if_else(Gene %in% c(top_pos$Gene, top_neg$Gene), 1.3, 1),
           top_lab  = if_else(Gene %in% c(top_pos$Gene, top_neg$Gene), Gene, ""))

  p <- ggplot(data, aes(x = !!sym(fc), y = -log10(!!sym(p_col)))) +
    geom_hline(yintercept = -log10(p_thresh), linetype = "dashed", color = "darkgrey") +
    geom_point(alpha = 0.5, aes(color = top_color, size = top_size)) +
    geom_text_repel(aes(label = top_lab, color = top_color),
                    size = 3, max.overlaps = Inf,
                    force = 6, segment.alpha = 0.3, segment.size = 0.3) +
    labs(title = paste(title_suffix),
         x = paste(x_axis),
         y = paste(y_axis)) +
    scale_size_continuous(range = c(1, 1.3)) + 
    scale_color_manual(values = c("#457b9d"="#457b9d", "#ced4da"="#ced4da", "#f28482"="#f28482")) +
    theme_minimal() +
    theme(legend.title = element_blank(),
          panel.grid = element_blank(),
          text = element_text(size = 15),
          title = element_text(size = 9)) +
    guides(color = "none", size = "none")

  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Volcano Plots/", file_suffix, "_croc.jpeg"), plot = p, width = 7, height = 5)
  return(p)
}

```

```{r echo = F}
# List of acronyms to uppercase
acronyms <- c("rna", "dna", "mtor", "foxo", "ppar", "nmd", "fgfr", "robo", 
              "bhl", "cov", "jak", "stat", "wnt", "hiv", "bcl", "mapk",
              "pt", "tal", "pc", "ic", "ec", "fibvsmcp",
              unique(pt_emmeans_df_mod1$Gene))
special_mixed <- c("rrna", "mrna", "trna", "gtpase", "atpase", "robos", "slits", "fibvsmcp")
special_replacements <- c("rRNA", "mRNA", "tRNA", "GTPase", "ATPase", "ROBOs", "SLITs", "FIB/VSMC/P")

replace_mixed_case <- function(text, from, to) {
  for (i in seq_along(from)) {
    pattern <- paste0("\\b", from[i], "\\b")
    text <- str_replace_all(text, regex(pattern, ignore_case = TRUE), to[i])
  }
  return(text)
}

capitalize_acronyms <- function(text, terms) {
  for (term in terms) {
    pattern <- paste0("\\b", term, "\\b")
    replacement <- toupper(term)
    text <- str_replace_all(text, regex(pattern, ignore_case = TRUE), replacement)
  }
  return(text)
}
plot_fgsea <- function(fgsea_res,
                            top_n = 30,
                            title = "Top Enriched Pathways",
                            xmax = 3,
                            xnudge = xlimit/100,
                            text1 = 6.5,
                            text2 = 18,
                            text3 = 20,
                       face = "plain") {
  
fgsea_res <- fgsea_res %>%
  arrange(pval) %>%
  head(top_n) %>%
  mutate(
    direction = case_when(NES < 0 ~ "Negative", NES > 0 ~ "Positive"),
    pathway_clean = str_remove(pathway, "^KEGG_"), 
    pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
    pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
    pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
    pathway_clean = str_replace_all(pathway_clean, "_", " "),
    pathway_clean = str_to_sentence(pathway_clean),
    pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
    pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
    pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
    pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
    pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
    pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
    pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
    pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
    pathway_clean = paste0(pathway_clean, " (", size, ")")
  ) %>%
  arrange(pval)

  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, fgsea_res$pval)
  
  fgsea_res %>%
    ggplot(aes(x = -log10(pval), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = abs(NES), color = direction, alpha = 0.8)) +
    geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0")) +
    scale_x_continuous(limits = c(0, xlimit), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "-log(p-value)",
      y = "Pathways",
      color = "Direction",
      size = "NES",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

# nebula

### PT
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
croc_nebula_pt_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/CROCODILE comparison analysis/nebula/pt_croc_hvg_nebula_res_reml_offset.rds")
```
#### REML + Offset
```{r echo = F}
# nebula only keeps results for converged
croc_pt_nebula_convergence_reml_offset <- map_dfr(
  names(croc_nebula_pt_results_list_reml_offset),
  function(gene_name) {
    converged <- croc_nebula_pt_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

croc_pt_nebula_converged_reml_offset <- croc_pt_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

croc_pt_nebula_res_combined_reml_offset <- map_dfr(
  names(croc_nebula_pt_results_list_reml_offset),
  function(gene_name) {
    df <- croc_nebula_pt_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% croc_pt_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name,
             fdr_interaction = p.adjust(`p_groupType_1_Diabetes`, method = "fdr"))
    return(df)
  }
)

croc_pt_nebula_disp_combined_reml_offset <- map_dfr(
  names(croc_nebula_pt_results_list_reml_offset),
  function(gene_name) {
    df <- croc_nebula_pt_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(croc_pt_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "p_groupType_1_Diabetes",
             "nebula PT (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(p-value)",
             "CROCODILE comparison analysis/pt_croc_pvalue_nebula_reml_offset")

plot_volcano(croc_pt_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "fdr_interaction",
             "nebula PT (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(FDR adjusted p-value)",
             "CROCODILE comparison analysis/pt_croc_pvalue_nebula_reml_offset")
```


#### GSEA (fgsea)
```{r echo = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercept = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(croc_pt_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(croc_pt_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(croc_pt_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_croc_pt_nebula_reml_offset <- croc_pt_nebula_res_combined_reml_offset$`logFC_groupType_1_Diabetes`
names(rankings_croc_pt_nebula_reml_offset) <- croc_pt_nebula_res_combined_reml_offset$Gene
rankings_croc_pt_nebula_reml_offset <- sort(rankings_croc_pt_nebula_reml_offset, decreasing = TRUE)
plot(rankings_croc_pt_nebula_reml_offset)
min(rankings_croc_pt_nebula_reml_offset)
max(rankings_croc_pt_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_croc_pt_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_croc_pt_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_croc_pt_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_croc_pt_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_croc_pt_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_croc_pt_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_croc_pt_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_croc_pt_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_croc_pt_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_croc_pt_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_croc_pt_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_croc_pt_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
##### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_croc_pt_nebula_reml_offset, title = "PT nebula Top 30 KEGG (REML & Offset)", xmin = 1.2, xmax = 2.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/croc_pt_nebula_top30_kegg_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_croc_pt_nebula_reml_offset, title = "PT nebula Top 30 REACTOME (REML & Offset)", xmin = 1.5, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/croc_pt_nebula_top30_reactome_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea_transpose(go_res_croc_pt_nebula_reml_offset, title = "PT nebula Top 30 GO (REML & Offset)", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/croc_pt_nebula_top30_go_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```


### TAL

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_tal_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/CROCODILE comparison analysis/nebula/tal_croc_hvg_nebula_res_reml_offset.rds")
```

#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
tal_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_tal_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_tal_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

tal_nebula_converged_reml_offset <- tal_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

tal_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_tal_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_tal_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% tal_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name,
             fdr_interaction = p.adjust(`p_groupType_1_Diabetes`, method = "fdr"))
    return(df)
  }
)

tal_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_tal_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_tal_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(tal_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "p_groupType_1_Diabetes",
             "nebula TAL (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(p-value)",
             "CROCODILE comparison analysis/tal_croc_pvalue_nebula_reml_offset")

plot_volcano(tal_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "fdr_interaction",
             "nebula TAL (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(FDR adjusted p-value)",
             "CROCODILE comparison analysis/tal_croc_pvalue_nebula_reml_offset")
```
##### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_nebula_reml_offset <- tal_nebula_res_combined_reml_offset$`logFC_groupType_1_Diabetes`
names(rankings_tal_nebula_reml_offset) <- tal_nebula_res_combined_reml_offset$Gene
rankings_tal_nebula_reml_offset <- sort(rankings_tal_nebula_reml_offset, decreasing = TRUE)
plot(rankings_tal_nebula_reml_offset)
min(rankings_tal_nebula_reml_offset)
max(rankings_tal_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_tal_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_tal_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_tal_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_tal_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_tal_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
###### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_tal_nebula_reml_offset, title = "TAL nebula Top 30 KEGG (REML & Offset)", xmin = 1.3, xmax = 3.1)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_kegg_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_tal_nebula_reml_offset, title = "TAL nebula Top 30 REACTOME (REML & Offset)", xmin = 1.5, xmax = 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_reactome_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### GO
```{r echo = F}
plot_fgsea_transpose(go_res_tal_nebula_reml_offset, title = "TAL nebula Top 30 GO (REML & Offset)", xmin = 1.5, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_go_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### PC

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_pc_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/CROCODILE comparison analysis/nebula/pc_croc_hvg_nebula_res_reml_offset.rds")
```

#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
pc_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_pc_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_pc_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pc_nebula_converged_reml_offset <- pc_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

pc_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_pc_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_pc_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pc_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name,
             fdr_interaction = p.adjust(`p_groupType_1_Diabetes`, method = "fdr"))
    return(df)
  }
)

pc_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_pc_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_pc_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pc_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "p_groupType_1_Diabetes",
             "nebula PC (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(p-value)",
             "CROCODILE comparison analysis/pc_croc_pvalue_nebula_reml_offset")

plot_volcano(pc_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "fdr_interaction",
             "nebula PC (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(FDR adjusted p-value)",
             "CROCODILE comparison analysis/pc_croc_pvalue_nebula_reml_offset")
```
##### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_nebula_reml_offset <- pc_nebula_res_combined_reml_offset$`logFC_groupType_1_Diabetes`
names(rankings_pc_nebula_reml_offset) <- pc_nebula_res_combined_reml_offset$Gene
rankings_pc_nebula_reml_offset <- sort(rankings_pc_nebula_reml_offset, decreasing = TRUE)
plot(rankings_pc_nebula_reml_offset)
min(rankings_pc_nebula_reml_offset)
max(rankings_pc_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pc_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_pc_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_pc_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_pc_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_pc_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
###### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_pc_nebula_reml_offset, title = "PC nebula Top 30 KEGG (REML & Offset)", xmin = 1.2, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_kegg_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_pc_nebula_reml_offset, title = "PC nebula Top 30 REACTOME (REML & Offset)", xmin = 1.4, xmax = 2.4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_reactome_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### GO
```{r echo = F}
plot_fgsea_transpose(go_res_pc_nebula_reml_offset, title = "PC nebula Top 30 GO (REML & Offset)", xmin = 1.5, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_go_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```


### Immune (very few cells)


```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)

nebula_immune_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/CROCODILE comparison analysis/nebula/immune_croc_hvg_nebula_res_reml_offset.rds")
```

#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
immune_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_immune_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_immune_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_nebula_converged_reml_offset <- immune_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

immune_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_immune_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_immune_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name,
             fdr_interaction = p.adjust(`p_groupType_1_Diabetes`, method = "fdr"))
    return(df)
  }
)

immune_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_immune_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_immune_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(immune_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "p_groupType_1_Diabetes",
             "nebula Immune (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(p-value)",
             "CROCODILE comparison analysis/immune_croc_pvalue_nebula_reml_offset")

plot_volcano(immune_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "fdr_interaction",
             "nebula Immune (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(FDR adjusted p-value)",
             "CROCODILE comparison analysis/immune_croc_pvalue_nebula_reml_offset")
```
##### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_nebula_reml_offset <- immune_nebula_res_combined_reml_offset$`logFC_groupType_1_Diabetes`
names(rankings_immune_nebula_reml_offset) <- immune_nebula_res_combined_reml_offset$Gene
rankings_immune_nebula_reml_offset <- sort(rankings_immune_nebula_reml_offset, decreasing = TRUE)
plot(rankings_immune_nebula_reml_offset)
min(rankings_immune_nebula_reml_offset)
max(rankings_immune_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_immune_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_immune_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_immune_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_immune_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_immune_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
###### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_immune_nebula_reml_offset, title = "Immune nebula Top 30 KEGG (REML & Offset)", xmin = 1.1, xmax = 2.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_top30_kegg_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_immune_nebula_reml_offset, title = "Immune nebula Top 30 REACTOME (REML & Offset)", xmin = 1.2, xmax = 2.8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_top30_reactome_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### GO
```{r echo = F}
plot_fgsea_transpose(go_res_immune_nebula_reml_offset, title = "Immune nebula Top 30 GO (REML & Offset)", xmin = 1.5, xmax = 2.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_top30_go_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### IC

```{r echo = F}

nebula_ic_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/CROCODILE comparison analysis/nebula/ic_croc_hvg_nebula_res_reml_offset.rds")
```

#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
ic_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_ic_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_ic_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ic_nebula_converged_reml_offset <- ic_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

ic_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_ic_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_ic_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ic_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name,
             fdr_interaction = p.adjust(`p_groupType_1_Diabetes`, method = "fdr"))
    return(df)
  }
)

ic_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_ic_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_ic_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ic_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "p_groupType_1_Diabetes",
             "nebula IC (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(p-value)",
             "CROCODILE comparison analysis/ic_croc_pvalue_nebula_reml_offset")

plot_volcano(ic_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "fdr_interaction",
             "nebula IC (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(FDR adjusted p-value)",
             "CROCODILE comparison analysis/ic_croc_pvalue_nebula_reml_offset")
```
##### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_nebula_reml_offset <- ic_nebula_res_combined_reml_offset$`logFC_groupType_1_Diabetes`
names(rankings_ic_nebula_reml_offset) <- ic_nebula_res_combined_reml_offset$Gene
rankings_ic_nebula_reml_offset <- sort(rankings_ic_nebula_reml_offset, decreasing = TRUE)
plot(rankings_ic_nebula_reml_offset)
min(rankings_ic_nebula_reml_offset)
max(rankings_ic_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ic_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_ic_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_ic_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_ic_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_ic_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
###### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_ic_nebula_reml_offset, title = "IC nebula Top 30 KEGG (REML & Offset)", xmin = 1, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_kegg_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_ic_nebula_reml_offset, title = "IC nebula Top 30 REACTOME (REML & Offset)", xmin = 1.2, xmax = 2.1)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_reactome_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### GO
```{r echo = F}
plot_fgsea_transpose(go_res_ic_nebula_reml_offset, title = "IC nebula Top 30 GO (REML & Offset)", xmin = 1.4, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_go_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### EC

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_ec_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/CROCODILE comparison analysis/nebula/ec_croc_hvg_nebula_res_reml_offset.rds")
```


#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
ec_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_ec_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_ec_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ec_nebula_converged_reml_offset <- ec_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

ec_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_ec_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_ec_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ec_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name,
             fdr_interaction = p.adjust(`p_groupType_1_Diabetes`, method = "fdr"))
    return(df)
  }
)

ec_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_ec_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_ec_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ec_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "p_groupType_1_Diabetes",
             "nebula EC (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(p-value)",
             "CROCODILE comparison analysis/ec_croc_pvalue_nebula_reml_offset")

plot_volcano(ec_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "fdr_interaction",
             "nebula EC (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(FDR adjusted p-value)",
             "CROCODILE comparison analysis/ec_croc_pvalue_nebula_reml_offset")
```
##### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_nebula_reml_offset <- ec_nebula_res_combined_reml_offset$`logFC_groupType_1_Diabetes`
names(rankings_ec_nebula_reml_offset) <- ec_nebula_res_combined_reml_offset$Gene
rankings_ec_nebula_reml_offset <- sort(rankings_ec_nebula_reml_offset, decreasing = TRUE)
plot(rankings_ec_nebula_reml_offset)
min(rankings_ec_nebula_reml_offset)
max(rankings_ec_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ec_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_ec_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_ec_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_ec_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_ec_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
###### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_ec_nebula_reml_offset, title = "EC nebula Top 30 KEGG (REML & Offset)", xmin = 1.1, xmax = 2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_kegg_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_ec_nebula_reml_offset, title = "EC nebula Top 30 REACTOME (REML & Offset)", xmin = 1.3, xmax = 1.8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_reactome_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### GO
```{r echo = F}
plot_fgsea_transpose(go_res_ec_nebula_reml_offset, title = "EC nebula Top 30 GO (REML & Offset)", xmin = 1.3, xmax = 2.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_go_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### FIB/VSMC/P
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_fibvsmc_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/CROCODILE comparison analysis/nebula/fibvsmc_croc_hvg_nebula_res_reml_offset.rds")
```

#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
fibvsmc_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_fibvsmc_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

fibvsmc_nebula_converged_reml_offset <- fibvsmc_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

fibvsmc_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% fibvsmc_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name,
             fdr_interaction = p.adjust(`p_groupType_1_Diabetes`, method = "fdr"))
    return(df)
  }
)

fibvsmc_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(fibvsmc_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "p_groupType_1_Diabetes",
             "nebula FIB/VSMC/P (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(p-value)",
             "CROCODILE comparison analysis/fibvsmc_croc_pvalue_nebula_reml_offset")

plot_volcano(fibvsmc_nebula_res_combined_reml_offset, "logFC_groupType_1_Diabetes", 
             "fdr_interaction",
             "nebula FIB/VSMC/P (REML & Offset)", 
             "logFC group (Type 1 Diabetes)", 
             "-log10(FDR adjusted p-value)",
             "CROCODILE comparison analysis/fibvsmc_croc_pvalue_nebula_reml_offset")
```
##### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(fibvsmc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(fibvsmc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(fibvsmc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_fibvsmc_nebula_reml_offset <- fibvsmc_nebula_res_combined_reml_offset$`logFC_groupType_1_Diabetes`
names(rankings_fibvsmc_nebula_reml_offset) <- fibvsmc_nebula_res_combined_reml_offset$Gene
rankings_fibvsmc_nebula_reml_offset <- sort(rankings_fibvsmc_nebula_reml_offset, decreasing = TRUE)
plot(rankings_fibvsmc_nebula_reml_offset)
min(rankings_fibvsmc_nebula_reml_offset)
max(rankings_fibvsmc_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_fibvsmc_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_fibvsmc_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_fibvsmc_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_fibvsmc_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_fibvsmc_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_fibvsmc_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_fibvsmc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_fibvsmc_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_fibvsmc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_fibvsmc_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_fibvsmc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_fibvsmc_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
###### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_fibvsmc_nebula_reml_offset, title = "FIB/VSMC/P nebula Top 30 KEGG (REML & Offset)", xmin = 1.1, xmax = 2.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_kegg_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_fibvsmc_nebula_reml_offset, title = "FIB/VSMC/P nebula Top 30 REACTOME (REML & Offset)", xmin = 1.4, xmax = 2.1)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_reactome_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### GO
```{r echo = F}
plot_fgsea_transpose(go_res_fibvsmc_nebula_reml_offset, title = "FIB/VSMC/P nebula Top 30 GO (REML & Offset)", xmin = 1.45, xmax = 2.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_go_pathways_croc.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## IPA pathway results

```{r echo = F}
text1 = 6.5
text2 = 18
text3 = 20
scenario_colors = c("Activated in D, stable/inhibited in P" = "#81171b",
                    "Activated in both, more in D" = "#ad2e24",
                    "Stable in D, inhibited in P" = "#c75146",
                    "Inhibited in both, less in D" = "#ea8c55",
                    "Activated in P, stable/inhibited in D" = "#1d3461",
                    "Activated in both, less in D" = "#004ba8",
                    "Stable in P, inhibited in D" = "#2c7da0", 
                    "Inhibited in both, more in D" = "#22aed1")
```

### PT

```{r echo = F}
pt_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pt_DiD_pathways.xls", skip = 1) 
pt_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pt_dapa_pathways.xls", skip = 1) 
pt_croc_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pt_croc_pathways.xls", skip = 1) 

colnames(pt_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pt_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pt_croc_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pt_pathways_merged_mod1 <- pt_pathways_mod1 %>%
  full_join(pt_dapa_mod1) %>% full_join(pt_croc_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))
```


```{r echo = F}
pt_pathways_merged_mod1$scenario <- factor(pt_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pt_pathways_inhibited_mod1 <- pt_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_inhibited_mod1$pathway <- reorder(pt_pathways_inhibited_mod1$pathway, pt_pathways_inhibited_mod1$neg_log_p)
  
pt_top30_inhibited_mod1 <- pt_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_inhibited_mod1 <- pt_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()
## pt_inhibited_scenarios <- as.data.frame(table(pt_pathways_inhibited_mod1$scenario))[5:8,] %>%
##   mutate(percent = (Freq / nrow(pt_pathways_inhibited_mod1))*100) %>%
##   ggplot(aes(x = Var1, y = percent, fill = Var1)) + 
##   geom_col() +
##   scale_fill_manual(values = scenario_colors) +
##   scale_x_discrete(drop = T) +
##   theme_minimal() +
##   theme(panel.grid = element_blank(),
##         axis.text.x = element_text(size = text2,
##                                    angle = 30,
##                                    hjust = 1),
##         axis.ticks.y = element_blank(), 
##         legend.position = "none",
##         text = element_text(size = text3),
##         panel.background = element_rect(color="black")) +
##   labs(y = "Percent",
##        x = NULL,
##        fill = "Scenario") +
##   ylim(c(0,50))
## 
## pt_top30_inhibited_mod1 + inset_element(pt_inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.8, top = 0.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pt_top30_inhibited_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pt_pathways_inhibited_sig_mod1 <- pt_pathways_inhibited_mod1 %>%
  filter(z <= -2)
pt_top30_inhibited_2_mod1 <- pt_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pt_pathways_inhibited_sig_mod1$z), max(-pt_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) 

## top30_inhibited_mod1 + inset_element(inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.80, top = 0.6)
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pt_top_inhibited_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pt_pathways_activated_mod1 <- pt_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_activated_mod1$pathway <- reorder(pt_pathways_activated_mod1$pathway, pt_pathways_activated_mod1$neg_log_p)
  
pt_top30_activated_mod1 <- pt_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_activated_mod1 <- pt_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pt_top30_activated_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pt_pathways_activated_sig_mod1 <- pt_pathways_activated_mod1 %>%
  filter(z > 2)
pt_top30_activated_2_mod1 <- pt_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pt_pathways_activated_sig_mod1$z), max(pt_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.125, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pt_top_activated_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pt_neg_pathways_merged_long_mod1 <- pt_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_neg_pathways_merged_long_mod1$name <- factor(pt_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/pt_top10_inhibited_pathway_zscores_croc.jpeg",
       scale = 1.5)

pt_pos_pathways_merged_long_mod1 <- pt_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_pos_pathways_merged_long_mod1$name <- factor(pt_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_pos_pathways_merged_long_mod1
pt_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 20, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/pt_top10_activated_pathway_zscores_croc.jpeg",
       scale = 1.5)
```

### TAL

```{r echo = F}
tal_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/tal_DiD_pathways.xls", skip = 1) 
tal_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/tal_dapa_pathways.xls", skip = 1) 
tal_croc_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/tal_croc_pathways.xls", skip = 1) 

colnames(tal_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(tal_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(tal_croc_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

tal_pathways_merged_mod1 <- tal_pathways_mod1 %>%
  full_join(tal_dapa_mod1) %>% full_join(tal_croc_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo)  %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

tal_pathways_merged_mod1$scenario <- factor(tal_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
tal_pathways_inhibited_mod1 <- tal_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_inhibited_mod1$pathway <- reorder(tal_pathways_inhibited_mod1$pathway, tal_pathways_inhibited_mod1$neg_log_p)
  
tal_top30_inhibited_mod1 <- tal_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_inhibited_mod1 <- tal_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/tal_top30_inhibited_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
tal_pathways_inhibited_sig_mod1 <- tal_pathways_inhibited_mod1 %>%
  filter(z < -2)
tal_top30_inhibited_2_mod1 <- tal_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-tal_pathways_inhibited_sig_mod1$z), max(-tal_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/tal_top_inhibited_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
tal_pathways_activated_mod1 <- tal_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_activated_mod1$pathway <- reorder(tal_pathways_activated_mod1$pathway, tal_pathways_activated_mod1$neg_log_p)
  
tal_top30_activated_mod1 <- tal_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 2.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_activated_mod1 <- tal_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/tal_top30_activated_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
tal_pathways_activated_sig_mod1 <- tal_pathways_activated_mod1 %>%
  filter(z > 2)
tal_top30_activated_2_mod1 <- tal_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(tal_pathways_activated_sig_mod1$z), max(tal_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/tal_top_activated_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
tal_neg_pathways_merged_long_mod1 <- tal_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_neg_pathways_merged_long_mod1$name <- factor(tal_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/tal_top10_inhibited_pathway_zscores_croc.jpeg",
       scale = 1.5)

tal_pos_pathways_merged_long_mod1 <- tal_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_pos_pathways_merged_long_mod1$name <- factor(tal_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_pos_pathways_merged_long_mod1
tal_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/tal_top10_activated_pathway_zscores_croc.jpeg",
       scale = 1.5)
```

### PC

```{r echo = F}
pc_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pc_DiD_pathways.xls", skip = 1) 
pc_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pc_dapa_pathways.xls", skip = 1) 
pc_croc_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pc_croc_pathways.xls", skip = 1) 

colnames(pc_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pc_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pc_croc_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pc_pathways_merged_mod1 <- pc_pathways_mod1 %>%
  full_join(pc_dapa_mod1) %>% full_join(pc_croc_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

pc_pathways_merged_mod1$scenario <- factor(pc_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pc_pathways_inhibited_mod1 <- pc_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_inhibited_mod1$pathway <- reorder(pc_pathways_inhibited_mod1$pathway, pc_pathways_inhibited_mod1$neg_log_p)
  
pc_top30_inhibited_mod1 <- pc_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_inhibited_mod1 <- pc_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pc_top30_inhibited_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pc_pathways_inhibited_sig_mod1 <- pc_pathways_inhibited_mod1 %>%
  filter(z < -2)
pc_top30_inhibited_2_mod1 <- pc_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pc_pathways_inhibited_sig_mod1$z), max(-pc_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pc_top_inhibited_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pc_pathways_activated_mod1 <- pc_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_activated_mod1$pathway <- reorder(pc_pathways_activated_mod1$pathway, pc_pathways_activated_mod1$neg_log_p)
  
pc_top30_activated_mod1 <- pc_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_activated_mod1 <- pc_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pc_top30_activated_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pc_pathways_activated_sig_mod1 <- pc_pathways_activated_mod1 %>%
  filter(z > 2)
pc_top30_activated_2_mod1 <- pc_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pc_pathways_activated_sig_mod1$z), max(pc_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.4, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pc_top_activated_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pc_neg_pathways_merged_long_mod1 <- pc_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_neg_pathways_merged_long_mod1$name <- factor(pc_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/pc_top10_inhibited_pathway_zscores_croc.jpeg",
       scale = 1.5)

pc_pos_pathways_merged_long_mod1 <- pc_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_pos_pathways_merged_long_mod1$name <- factor(pc_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_pos_pathways_merged_long_mod1
pc_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/pc_top10_activated_pathway_zscores_croc.jpeg",
       scale = 1.5)
```

### Immune (very few cells)

```{r echo = F}
immune_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/immune_DiD_pathways.xls", skip = 1) 
immune_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/immune_dapa_pathways.xls", skip = 1) 
immune_croc_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/immune_croc_pathways.xls", skip = 1) 

colnames(immune_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(immune_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(immune_croc_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

immune_pathways_merged_mod1 <- immune_pathways_mod1 %>%
  full_join(immune_dapa_mod1) %>% full_join(immune_croc_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

immune_pathways_merged_mod1$scenario <- factor(immune_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
immune_pathways_inhibited_mod1 <- immune_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_inhibited_mod1$pathway <- reorder(immune_pathways_inhibited_mod1$pathway, immune_pathways_inhibited_mod1$neg_log_p)
  
immune_top30_inhibited_mod1 <- immune_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_inhibited_mod1 <- immune_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/immune_top30_inhibited_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
immune_pathways_inhibited_sig_mod1 <- immune_pathways_inhibited_mod1 %>%
  filter(z < -2)
immune_top30_inhibited_2_mod1 <- immune_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-immune_pathways_inhibited_sig_mod1$z), max(-immune_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/immune_top_inhibited_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
immune_pathways_activated_mod1 <- immune_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_activated_mod1$pathway <- reorder(immune_pathways_activated_mod1$pathway, immune_pathways_activated_mod1$neg_log_p)
  
immune_top30_activated_mod1 <- immune_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_activated_mod1 <- immune_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/immune_top30_activated_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
immune_pathways_activated_sig_mod1 <- immune_pathways_activated_mod1 %>%
  filter(z > 2)
immune_top30_activated_2_mod1 <- immune_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(immune_pathways_activated_sig_mod1$z), max(immune_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/immune_top_activated_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
immune_neg_pathways_merged_long_mod1 <- immune_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_neg_pathways_merged_long_mod1$name <- factor(immune_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 60, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/immune_top10_inhibited_pathway_zscores_croc.jpeg",
       scale = 1.5)

immune_pos_pathways_merged_long_mod1 <- immune_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_pos_pathways_merged_long_mod1$name <- factor(immune_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_pos_pathways_merged_long_mod1
immune_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/immune_top10_activated_pathway_zscores_croc.jpeg",
       scale = 1.5)
```

### IC

```{r echo = F}
ic_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ic_DiD_pathways.xls", skip = 1) 
ic_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ic_dapa_pathways.xls", skip = 1) 
ic_croc_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ic_croc_pathways.xls", skip = 1) 

colnames(ic_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ic_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ic_croc_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ic_pathways_merged_mod1 <- ic_pathways_mod1 %>%
  full_join(ic_dapa_mod1) %>% full_join(ic_croc_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ic_pathways_merged_mod1$scenario <- factor(ic_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ic_pathways_inhibited_mod1 <- ic_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_inhibited_mod1$pathway <- reorder(ic_pathways_inhibited_mod1$pathway, ic_pathways_inhibited_mod1$neg_log_p)
  
ic_top30_inhibited_mod1 <- ic_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_inhibited_mod1 <- ic_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ic_top30_inhibited_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ic_pathways_inhibited_sig_mod1 <- ic_pathways_inhibited_mod1 %>%
  filter(z < -2)
ic_top30_inhibited_2_mod1 <- ic_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ic_pathways_inhibited_sig_mod1$z), max(-ic_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ic_top_inhibited_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ic_pathways_activated_mod1 <- ic_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_activated_mod1$pathway <- reorder(ic_pathways_activated_mod1$pathway, ic_pathways_activated_mod1$neg_log_p)
  
ic_top30_activated_mod1 <- ic_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_activated_mod1 <- ic_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ic_top30_activated_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ic_pathways_activated_sig_mod1 <- ic_pathways_activated_mod1 %>%
  filter(z > 2)
ic_top30_activated_2_mod1 <- ic_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ic_pathways_activated_sig_mod1$z), max(ic_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ic_top_activated_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ic_neg_pathways_merged_long_mod1 <- ic_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_neg_pathways_merged_long_mod1$name <- factor(ic_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/ic_top10_inhibited_pathway_zscores_croc.jpeg",
       scale = 1.5)

ic_pos_pathways_merged_long_mod1 <- ic_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_pos_pathways_merged_long_mod1$name <- factor(ic_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_pos_pathways_merged_long_mod1
ic_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/ic_top10_activated_pathway_zscores_croc.jpeg",
       scale = 1.5)
```

### EC

```{r echo = F}
ec_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ec_DiD_pathways.xls", skip = 1) 
ec_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ec_dapa_pathways.xls", skip = 1) 
ec_croc_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ec_croc_pathways.xls", skip = 1) 

colnames(ec_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ec_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ec_croc_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ec_pathways_merged_mod1 <- ec_pathways_mod1 %>%
  full_join(ec_dapa_mod1) %>% full_join(ec_croc_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ec_pathways_merged_mod1$scenario <- factor(ec_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ec_pathways_inhibited_mod1 <- ec_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_inhibited_mod1$pathway <- reorder(ec_pathways_inhibited_mod1$pathway, ec_pathways_inhibited_mod1$neg_log_p)
  
ec_top30_inhibited_mod1 <- ec_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_inhibited_mod1 <- ec_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ec_top30_inhibited_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ec_pathways_inhibited_sig_mod1 <- ec_pathways_inhibited_mod1 %>%
  filter(z < -2)
ec_top30_inhibited_2_mod1 <- ec_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ec_pathways_inhibited_sig_mod1$z), max(-ec_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ec_top_inhibited_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ec_pathways_activated_mod1 <- ec_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_activated_mod1$pathway <- reorder(ec_pathways_activated_mod1$pathway, ec_pathways_activated_mod1$neg_log_p)
  
ec_top30_activated_mod1 <- ec_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_activated_mod1 <- ec_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ec_top30_activated_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ec_pathways_activated_sig_mod1 <- ec_pathways_activated_mod1 %>%
  filter(z > 2)
ec_top30_activated_2_mod1 <- ec_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ec_pathways_activated_sig_mod1$z), max(ec_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ec_top_activated_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ec_neg_pathways_merged_long_mod1 <- ec_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_neg_pathways_merged_long_mod1$name <- factor(ec_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/ec_top10_inhibited_pathway_zscores_croc.jpeg",
       scale = 1.5)

ec_pos_pathways_merged_long_mod1 <- ec_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_pos_pathways_merged_long_mod1$name <- factor(ec_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_pos_pathways_merged_long_mod1
ec_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/ec_top10_activated_pathway_zscores_croc.jpeg",
       scale = 1.5)
```

### DTL (very few cells)

```{r echo = F, eval = F}
dtl_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/dtl_DiD_pathways.xls", skip = 1) 
dtl_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/dtl_dapa_pathways.xls", skip = 1) 
dtl_croc_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/dtl_croc_pathways.xls", skip = 1) 

colnames(dtl_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(dtl_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(dtl_croc_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

dtl_pathways_merged_mod1 <- dtl_pathways_mod1 %>%
  full_join(dtl_dapa_mod1) %>% full_join(dtl_croc_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

dtl_pathways_merged_mod1$scenario <- factor(dtl_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F, eval = F}
dtl_pathways_inhibited_mod1 <- dtl_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_inhibited_mod1$pathway <- reorder(dtl_pathways_inhibited_mod1$pathway, dtl_pathways_inhibited_mod1$neg_log_p)
  
dtl_top30_inhibited_mod1 <- dtl_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_inhibited_mod1 <- dtl_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/dtl_top30_inhibited_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2 (none significant)
## dtl_pathways_inhibited_sig_mod1 <- dtl_pathways_inhibited_mod1 %>%
##   filter(z < -2)
## dtl_top30_inhibited_2_mod1 <- dtl_pathways_inhibited_sig_mod1[1:30,] %>%
##   ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
##   geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
##   scale_size_continuous(range = c(min(-dtl_pathways_inhibited_sig_mod1$z), max(-dtl_pathways_inhibited_sig_mod1$z)),
##                         labels = function(x) paste0("-", x)) +
##   geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
##   geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
##   theme_bw() +
##   theme(axis.text.y = element_blank(),
##         panel.grid = element_blank(),
##         axis.text.x = element_text(size = text3),
##         axis.title = element_text(size = text3),
##         axis.ticks.y = element_blank(), 
##         legend.position = c(0.9,0.2),
##         legend.background = element_blank(),
##         legend.box.background = element_rect(color = "black"),
##         legend.title = element_text(size = text2),
##         legend.text = element_text(size = text2),
##         title = element_text (size = text3)) +
##   labs(x = "-log(p-value)",
##        y = "Pathways",
##        color = "Scenario",
##        size = "Z-score",
##        title = "DTL Top Inhibited Pathways (Z < -2)")   +
##   scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
##   scale_color_manual(values = scenario_colors)  +
##   scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 
## 
## ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/dtl_top_inhibited_pathways_2_croc.jpeg",
##        width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F, eval = F}
dtl_pathways_activated_mod1 <- dtl_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_activated_mod1$pathway <- reorder(dtl_pathways_activated_mod1$pathway, dtl_pathways_activated_mod1$neg_log_p)
  
dtl_top30_activated_mod1 <- dtl_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_activated_mod1 <- dtl_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/dtl_top30_activated_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
dtl_pathways_activated_sig_mod1 <- dtl_pathways_activated_mod1 %>%
  filter(z > 2)
dtl_top30_activated_2_mod1 <- dtl_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(dtl_pathways_activated_sig_mod1$z), max(dtl_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.05, 0.05))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/dtl_top_activated_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, eval = F}
## z-scores in bar charts
dtl_neg_pathways_merged_long_mod1 <- dtl_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_neg_pathways_merged_long_mod1$name <- factor(dtl_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/dtl_top10_inhibited_pathway_zscores_croc.jpeg",
       scale = 1.5)

dtl_pos_pathways_merged_long_mod1 <- dtl_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_pos_pathways_merged_long_mod1$name <- factor(dtl_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_pos_pathways_merged_long_mod1
dtl_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/dtl_top10_activated_pathway_zscores_croc.jpeg",
       scale = 1.5)
```

### FIB/VSMC/P

```{r echo = F}
fibvsmcp_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/fibvsmcp_DiD_pathways.xls", skip = 1) 
fibvsmcp_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/fibvsmcp_dapa_pathways.xls", skip = 1) 
fibvsmcp_croc_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/fibvsmcp_croc_pathways.xls", skip = 1) 

colnames(fibvsmcp_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(fibvsmcp_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(fibvsmcp_croc_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

fibvsmcp_pathways_merged_mod1 <- fibvsmcp_pathways_mod1 %>%
  full_join(fibvsmcp_dapa_mod1) %>% full_join(fibvsmcp_croc_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

fibvsmcp_pathways_merged_mod1$scenario <- factor(fibvsmcp_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
fibvsmcp_pathways_inhibited_mod1 <- fibvsmcp_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_inhibited_mod1$pathway <- reorder(fibvsmcp_pathways_inhibited_mod1$pathway, fibvsmcp_pathways_inhibited_mod1$neg_log_p)
  
fibvsmcp_top30_inhibited_mod1 <- fibvsmcp_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_inhibited_mod1 <- fibvsmcp_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/fibvsmcp_top30_inhibited_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
fibvsmcp_pathways_inhibited_sig_mod1 <- fibvsmcp_pathways_inhibited_mod1 %>%
  filter(z < -2)
fibvsmcp_top30_inhibited_2_mod1 <- fibvsmcp_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-fibvsmcp_pathways_inhibited_sig_mod1$z), max(-fibvsmcp_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.3, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/fibvsmcp_top_inhibited_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
fibvsmcp_pathways_activated_mod1 <- fibvsmcp_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_activated_mod1$pathway <- reorder(fibvsmcp_pathways_activated_mod1$pathway, fibvsmcp_pathways_activated_mod1$neg_log_p)
  
fibvsmcp_top30_activated_mod1 <- fibvsmcp_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_activated_mod1 <- fibvsmcp_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/fibvsmcp_top30_activated_pathways_mod1_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
fibvsmcp_pathways_activated_sig_mod1 <- fibvsmcp_pathways_activated_mod1 %>%
  filter(z > 2)
fibvsmcp_top30_activated_2_mod1 <- fibvsmcp_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(fibvsmcp_pathways_activated_sig_mod1$z), max(fibvsmcp_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/fibvsmcp_top_activated_pathways_2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
fibvsmcp_neg_pathways_merged_long_mod1 <- fibvsmcp_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_neg_pathways_merged_long_mod1$name <- factor(fibvsmcp_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 12, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/fibvsmcp_top10_inhibited_pathway_zscores_croc.jpeg",
       scale = 1.5)

fibvsmcp_pos_pathways_merged_long_mod1 <- fibvsmcp_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_pos_pathways_merged_long_mod1$name <- factor(fibvsmcp_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_pos_pathways_merged_long_mod1
fibvsmcp_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/fibvsmcp_top10_activated_pathway_zscores_croc.jpeg",
       scale = 1.5)
```

## IPA pathway results

```{r echo = F}
text1 = 6.5
text2 = 18
text3 = 20
scenario_colors = c("Activated in D, stable/inhibited in P" = "#81171b",
                    "Activated in both, more in D" = "#ad2e24",
                    "Stable in D, inhibited in P" = "#c75146",
                    "Inhibited in both, less in D" = "#ea8c55",
                    "Activated in P, stable/inhibited in D" = "#1d3461",
                    "Activated in both, less in D" = "#004ba8",
                    "Stable in P, inhibited in D" = "#2c7da0", 
                    "Inhibited in both, more in D" = "#22aed1")
```

### PT

```{r echo = F}
pt_pathways_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/pt_DiD_pathways_2.xls", skip = 1) 
pt_dapa_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/pt_dapa_pathways_2.xls", skip = 1) 
pt_croc_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/pt_croc_pathways_2.xls", skip = 1) 

colnames(pt_pathways_mod2) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pt_dapa_mod2) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pt_croc_mod2) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pt_pathways_merged_mod2 <- pt_pathways_mod2 %>%
  full_join(pt_dapa_mod2) %>% full_join(pt_croc_mod2) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))
```


```{r echo = F}
pt_pathways_merged_mod2$scenario <- factor(pt_pathways_merged_mod2$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pt_pathways_inhibited_mod2 <- pt_pathways_merged_mod2 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_inhibited_mod2$pathway <- reorder(pt_pathways_inhibited_mod2$pathway, pt_pathways_inhibited_mod2$neg_log_p)
  
pt_top30_inhibited_mod2 <- pt_pathways_inhibited_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 15), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_inhibited_mod2 <- pt_pathways_inhibited_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()
## pt_inhibited_scenarios <- as.data.frame(table(pt_pathways_inhibited_mod2$scenario))[5:8,] %>%
##   mutate(percent = (Freq / nrow(pt_pathways_inhibited_mod2))*100) %>%
##   ggplot(aes(x = Var1, y = percent, fill = Var1)) + 
##   geom_col() +
##   scale_fill_manual(values = scenario_colors) +
##   scale_x_discrete(drop = T) +
##   theme_minimal() +
##   theme(panel.grid = element_blank(),
##         axis.text.x = element_text(size = text2,
##                                    angle = 30,
##                                    hjust = 1),
##         axis.ticks.y = element_blank(), 
##         legend.position = "none",
##         text = element_text(size = text3),
##         panel.background = element_rect(color="black")) +
##   labs(y = "Percent",
##        x = NULL,
##        fill = "Scenario") +
##   ylim(c(0,50))
## 
## pt_top30_inhibited_mod2 + inset_element(pt_inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.8, top = 0.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/pt_top30_inhibited_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pt_pathways_inhibited_sig_mod2 <- pt_pathways_inhibited_mod2 %>%
  filter(z <= -2)
pt_top30_inhibited_2_mod2 <- pt_pathways_inhibited_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pt_pathways_inhibited_sig_mod2$z), max(-pt_pathways_inhibited_sig_mod2$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.3, 0))) 

## top30_inhibited_mod2 + inset_element(inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.80, top = 0.6)
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/pt_top_inhibited_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pt_pathways_activated_mod2 <- pt_pathways_merged_mod2 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_activated_mod2$pathway <- reorder(pt_pathways_activated_mod2$pathway, pt_pathways_activated_mod2$neg_log_p)
  
pt_top30_activated_mod2 <- pt_pathways_activated_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 20), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_activated_mod2 <- pt_pathways_activated_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/pt_top30_activated_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pt_pathways_activated_sig_mod2 <- pt_pathways_activated_mod2 %>%
  filter(z > 2)
pt_top30_activated_2_mod2 <- pt_pathways_activated_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pt_pathways_activated_sig_mod2$z), max(pt_pathways_activated_sig_mod2$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.125, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/pt_top_activated_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pt_neg_pathways_merged_long_mod2 <- pt_pathways_merged_mod2 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_neg_pathways_merged_long_mod2$name <- factor(pt_neg_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_neg_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/pt_top10_inhibited_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)

pt_pos_pathways_merged_long_mod2 <- pt_pathways_merged_mod2 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_pos_pathways_merged_long_mod2$name <- factor(pt_pos_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_pos_pathways_merged_long_mod2
pt_pos_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 20, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/pt_top10_activated_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)
```

### TAL

```{r echo = F}
tal_pathways_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/tal_DiD_pathways_2.xls", skip = 1) 
tal_dapa_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/tal_dapa_pathways_2.xls", skip = 1) 
tal_croc_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/tal_croc_pathways_2.xls", skip = 1) 

colnames(tal_pathways_mod2) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(tal_dapa_mod2) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(tal_croc_mod2) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

tal_pathways_merged_mod2 <- tal_pathways_mod2 %>%
  full_join(tal_dapa_mod2) %>% full_join(tal_croc_mod2) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo)  %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

tal_pathways_merged_mod2$scenario <- factor(tal_pathways_merged_mod2$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
tal_pathways_inhibited_mod2 <- tal_pathways_merged_mod2 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_inhibited_mod2$pathway <- reorder(tal_pathways_inhibited_mod2$pathway, tal_pathways_inhibited_mod2$neg_log_p)
  
tal_top30_inhibited_mod2 <- tal_pathways_inhibited_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 15), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_inhibited_mod2 <- tal_pathways_inhibited_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/tal_top30_inhibited_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
tal_pathways_inhibited_sig_mod2 <- tal_pathways_inhibited_mod2 %>%
  filter(z < -2)
tal_top30_inhibited_2_mod2 <- tal_pathways_inhibited_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-tal_pathways_inhibited_sig_mod2$z), max(-tal_pathways_inhibited_sig_mod2$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 20), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/tal_top_inhibited_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
tal_pathways_activated_mod2 <- tal_pathways_merged_mod2 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_activated_mod2$pathway <- reorder(tal_pathways_activated_mod2$pathway, tal_pathways_activated_mod2$neg_log_p)
  
tal_top30_activated_mod2 <- tal_pathways_activated_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.2) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 25), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_activated_mod2 <- tal_pathways_activated_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/tal_top30_activated_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
tal_pathways_activated_sig_mod2 <- tal_pathways_activated_mod2 %>%
  filter(z > 2)
tal_top30_activated_2_mod2 <- tal_pathways_activated_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(tal_pathways_activated_sig_mod2$z), max(tal_pathways_activated_sig_mod2$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.2) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 30), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/tal_top_activated_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
tal_neg_pathways_merged_long_mod2 <- tal_pathways_merged_mod2 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_neg_pathways_merged_long_mod2$name <- factor(tal_neg_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_neg_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/tal_top10_inhibited_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)

tal_pos_pathways_merged_long_mod2 <- tal_pathways_merged_mod2 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_pos_pathways_merged_long_mod2$name <- factor(tal_pos_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_pos_pathways_merged_long_mod2
tal_pos_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/tal_top10_activated_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)
```

### PC

```{r echo = F}
pc_pathways_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/pc_DiD_pathways_2.xls", skip = 1) 
pc_dapa_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/pc_dapa_pathways_2.xls", skip = 1) 
pc_croc_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/pc_croc_pathways_2.xls", skip = 1) 

colnames(pc_pathways_mod2) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pc_dapa_mod2) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pc_croc_mod2) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pc_pathways_merged_mod2 <- pc_pathways_mod2 %>%
  full_join(pc_dapa_mod2) %>% full_join(pc_croc_mod2) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

pc_pathways_merged_mod2$scenario <- factor(pc_pathways_merged_mod2$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pc_pathways_inhibited_mod2 <- pc_pathways_merged_mod2 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_inhibited_mod2$pathway <- reorder(pc_pathways_inhibited_mod2$pathway, pc_pathways_inhibited_mod2$neg_log_p)
  
pc_top30_inhibited_mod2 <- pc_pathways_inhibited_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.15) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 15), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_inhibited_mod2 <- pc_pathways_inhibited_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/pc_top30_inhibited_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pc_pathways_inhibited_sig_mod2 <- pc_pathways_inhibited_mod2 %>%
  filter(z < -2)
pc_top30_inhibited_2_mod2 <- pc_pathways_inhibited_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pc_pathways_inhibited_sig_mod2$z), max(-pc_pathways_inhibited_sig_mod2$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.15) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 15), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/pc_top_inhibited_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pc_pathways_activated_mod2 <- pc_pathways_merged_mod2 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_activated_mod2$pathway <- reorder(pc_pathways_activated_mod2$pathway, pc_pathways_activated_mod2$neg_log_p)
  
pc_top30_activated_mod2 <- pc_pathways_activated_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.2) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 20), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_activated_mod2 <- pc_pathways_activated_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/pc_top30_activated_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pc_pathways_activated_sig_mod2 <- pc_pathways_activated_mod2 %>%
  filter(z > 2)
pc_top30_activated_2_mod2 <- pc_pathways_activated_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pc_pathways_activated_sig_mod2$z), max(pc_pathways_activated_sig_mod2$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.4, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/pc_top_activated_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pc_neg_pathways_merged_long_mod2 <- pc_pathways_merged_mod2 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_neg_pathways_merged_long_mod2$name <- factor(pc_neg_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_neg_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/pc_top10_inhibited_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)

pc_pos_pathways_merged_long_mod2 <- pc_pathways_merged_mod2 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_pos_pathways_merged_long_mod2$name <- factor(pc_pos_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_pos_pathways_merged_long_mod2
pc_pos_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/pc_top10_activated_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)
```

### Immune (very few cells)

```{r echo = F}
immune_pathways_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/immune_DiD_pathways_2.xls", skip = 1) 
immune_dapa_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/immune_dapa_pathways_2.xls", skip = 1) 
immune_croc_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/immune_croc_pathways_2.xls", skip = 1) 

colnames(immune_pathways_mod2) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(immune_dapa_mod2) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(immune_croc_mod2) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

immune_pathways_merged_mod2 <- immune_pathways_mod2 %>%
  full_join(immune_dapa_mod2) %>% full_join(immune_croc_mod2) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

immune_pathways_merged_mod2$scenario <- factor(immune_pathways_merged_mod2$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
immune_pathways_inhibited_mod2 <- immune_pathways_merged_mod2 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_inhibited_mod2$pathway <- reorder(immune_pathways_inhibited_mod2$pathway, immune_pathways_inhibited_mod2$neg_log_p)
  
immune_top30_inhibited_mod2 <- immune_pathways_inhibited_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 8), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_inhibited_mod2 <- immune_pathways_inhibited_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/immune_top30_inhibited_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
immune_pathways_inhibited_sig_mod2 <- immune_pathways_inhibited_mod2 %>%
  filter(z < -2)
immune_top30_inhibited_2_mod2 <- immune_pathways_inhibited_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-immune_pathways_inhibited_sig_mod2$z), max(-immune_pathways_inhibited_sig_mod2$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/immune_top_inhibited_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
immune_pathways_activated_mod2 <- immune_pathways_merged_mod2 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_activated_mod2$pathway <- reorder(immune_pathways_activated_mod2$pathway, immune_pathways_activated_mod2$neg_log_p)
  
immune_top30_activated_mod2 <- immune_pathways_activated_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 10), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_activated_mod2 <- immune_pathways_activated_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/immune_top30_activated_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
immune_pathways_activated_sig_mod2 <- immune_pathways_activated_mod2 %>%
  filter(z > 2)
immune_top30_activated_2_mod2 <- immune_pathways_activated_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(immune_pathways_activated_sig_mod2$z), max(immune_pathways_activated_sig_mod2$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/immune_top_activated_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
immune_neg_pathways_merged_long_mod2 <- immune_pathways_merged_mod2 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_neg_pathways_merged_long_mod2$name <- factor(immune_neg_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_neg_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 60, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/immune_top10_inhibited_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)

immune_pos_pathways_merged_long_mod2 <- immune_pathways_merged_mod2 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_pos_pathways_merged_long_mod2$name <- factor(immune_pos_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_pos_pathways_merged_long_mod2
immune_pos_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/immune_top10_activated_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)
```

### IC

```{r echo = F}
ic_pathways_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/ic_DiD_pathways_2.xls", skip = 1) 
ic_dapa_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/ic_dapa_pathways_2.xls", skip = 1) 
ic_croc_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/ic_croc_pathways_2.xls", skip = 1) 

colnames(ic_pathways_mod2) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ic_dapa_mod2) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ic_croc_mod2) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ic_pathways_merged_mod2 <- ic_pathways_mod2 %>%
  full_join(ic_dapa_mod2) %>% full_join(ic_croc_mod2) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ic_pathways_merged_mod2$scenario <- factor(ic_pathways_merged_mod2$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ic_pathways_inhibited_mod2 <- ic_pathways_merged_mod2 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_inhibited_mod2$pathway <- reorder(ic_pathways_inhibited_mod2$pathway, ic_pathways_inhibited_mod2$neg_log_p)
  
ic_top30_inhibited_mod2 <- ic_pathways_inhibited_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 7), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_inhibited_mod2 <- ic_pathways_inhibited_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/ic_top30_inhibited_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ic_pathways_inhibited_sig_mod2 <- ic_pathways_inhibited_mod2 %>%
  filter(z < -2)
ic_top30_inhibited_2_mod2 <- ic_pathways_inhibited_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ic_pathways_inhibited_sig_mod2$z), max(-ic_pathways_inhibited_sig_mod2$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/ic_top_inhibited_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ic_pathways_activated_mod2 <- ic_pathways_merged_mod2 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_activated_mod2$pathway <- reorder(ic_pathways_activated_mod2$pathway, ic_pathways_activated_mod2$neg_log_p)
  
ic_top30_activated_mod2 <- ic_pathways_activated_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 12), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_activated_mod2 <- ic_pathways_activated_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/ic_top30_activated_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ic_pathways_activated_sig_mod2 <- ic_pathways_activated_mod2 %>%
  filter(z > 2)
ic_top30_activated_2_mod2 <- ic_pathways_activated_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ic_pathways_activated_sig_mod2$z), max(ic_pathways_activated_sig_mod2$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/ic_top_activated_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ic_neg_pathways_merged_long_mod2 <- ic_pathways_merged_mod2 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_neg_pathways_merged_long_mod2$name <- factor(ic_neg_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_neg_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/ic_top10_inhibited_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)

ic_pos_pathways_merged_long_mod2 <- ic_pathways_merged_mod2 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_pos_pathways_merged_long_mod2$name <- factor(ic_pos_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_pos_pathways_merged_long_mod2
ic_pos_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/ic_top10_activated_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)
```

### EC

```{r echo = F}
ec_pathways_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/ec_DiD_pathways_2.xls", skip = 1) 
ec_dapa_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/ec_dapa_pathways_2.xls", skip = 1) 
ec_croc_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/ec_croc_pathways_2.xls", skip = 1) 

colnames(ec_pathways_mod2) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ec_dapa_mod2) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ec_croc_mod2) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ec_pathways_merged_mod2 <- ec_pathways_mod2 %>%
  full_join(ec_dapa_mod2) %>% full_join(ec_croc_mod2) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ec_pathways_merged_mod2$scenario <- factor(ec_pathways_merged_mod2$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ec_pathways_inhibited_mod2 <- ec_pathways_merged_mod2 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_inhibited_mod2$pathway <- reorder(ec_pathways_inhibited_mod2$pathway, ec_pathways_inhibited_mod2$neg_log_p)
  
ec_top30_inhibited_mod2 <- ec_pathways_inhibited_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 12), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_inhibited_mod2 <- ec_pathways_inhibited_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/ec_top30_inhibited_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ec_pathways_inhibited_sig_mod2 <- ec_pathways_inhibited_mod2 %>%
  filter(z < -2)
ec_top30_inhibited_2_mod2 <- ec_pathways_inhibited_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ec_pathways_inhibited_sig_mod2$z), max(-ec_pathways_inhibited_sig_mod2$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/ec_top_inhibited_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ec_pathways_activated_mod2 <- ec_pathways_merged_mod2 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_activated_mod2$pathway <- reorder(ec_pathways_activated_mod2$pathway, ec_pathways_activated_mod2$neg_log_p)
  
ec_top30_activated_mod2 <- ec_pathways_activated_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 10), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_activated_mod2 <- ec_pathways_activated_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/ec_top30_activated_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ec_pathways_activated_sig_mod2 <- ec_pathways_activated_mod2 %>%
  filter(z > 2)
ec_top30_activated_2_mod2 <- ec_pathways_activated_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ec_pathways_activated_sig_mod2$z), max(ec_pathways_activated_sig_mod2$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/ec_top_activated_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ec_neg_pathways_merged_long_mod2 <- ec_pathways_merged_mod2 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_neg_pathways_merged_long_mod2$name <- factor(ec_neg_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_neg_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/ec_top10_inhibited_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)

ec_pos_pathways_merged_long_mod2 <- ec_pathways_merged_mod2 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_pos_pathways_merged_long_mod2$name <- factor(ec_pos_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_pos_pathways_merged_long_mod2
ec_pos_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/ec_top10_activated_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)
```

### DTL (very few cells)

```{r echo = F, eval = F}
dtl_pathways_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/dtl_DiD_pathways_2.xls", skip = 1) 
dtl_dapa_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/dtl_dapa_pathways_2.xls", skip = 1) 
dtl_croc_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/dtl_croc_pathways_2.xls", skip = 1) 

colnames(dtl_pathways_mod2) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(dtl_dapa_mod2) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(dtl_croc_mod2) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

dtl_pathways_merged_mod2 <- dtl_pathways_mod2 %>%
  full_join(dtl_dapa_mod2) %>% full_join(dtl_croc_mod2) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

dtl_pathways_merged_mod2$scenario <- factor(dtl_pathways_merged_mod2$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F, eval = F}
dtl_pathways_inhibited_mod2 <- dtl_pathways_merged_mod2 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_inhibited_mod2$pathway <- reorder(dtl_pathways_inhibited_mod2$pathway, dtl_pathways_inhibited_mod2$neg_log_p)
  
dtl_top30_inhibited_mod2 <- dtl_pathways_inhibited_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_inhibited_mod2 <- dtl_pathways_inhibited_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/dtl_top30_inhibited_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2 (none significant)
## dtl_pathways_inhibited_sig_mod2 <- dtl_pathways_inhibited_mod2 %>%
##   filter(z < -2)
## dtl_top30_inhibited_2_mod2 <- dtl_pathways_inhibited_sig_mod2[1:30,] %>%
##   ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
##   geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
##   scale_size_continuous(range = c(min(-dtl_pathways_inhibited_sig_mod2$z), max(-dtl_pathways_inhibited_sig_mod2$z)),
##                         labels = function(x) paste0("-", x)) +
##   geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
##   geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
##   theme_bw() +
##   theme(axis.text.y = element_blank(),
##         panel.grid = element_blank(),
##         axis.text.x = element_text(size = text3),
##         axis.title = element_text(size = text3),
##         axis.ticks.y = element_blank(), 
##         legend.position = c(0.9,0.2),
##         legend.background = element_blank(),
##         legend.box.background = element_rect(color = "black"),
##         legend.title = element_text(size = text2),
##         legend.text = element_text(size = text2),
##         title = element_text (size = text3)) +
##   labs(x = "-log(p-value)",
##        y = "Pathways",
##        color = "Scenario",
##        size = "Z-score",
##        title = "DTL Top Inhibited Pathways (Z < -2)")   +
##   scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
##   scale_color_manual(values = scenario_colors)  +
##   scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 
## 
## ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/dtl_top_inhibited_pathways_2_mod2_croc.jpeg",
##        width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F, eval = F}
dtl_pathways_activated_mod2 <- dtl_pathways_merged_mod2 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_activated_mod2$pathway <- reorder(dtl_pathways_activated_mod2$pathway, dtl_pathways_activated_mod2$neg_log_p)
  
dtl_top30_activated_mod2 <- dtl_pathways_activated_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_activated_mod2 <- dtl_pathways_activated_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/dtl_top30_activated_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
dtl_pathways_activated_sig_mod2 <- dtl_pathways_activated_mod2 %>%
  filter(z > 2)
dtl_top30_activated_2_mod2 <- dtl_pathways_activated_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(dtl_pathways_activated_sig_mod2$z), max(dtl_pathways_activated_sig_mod2$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.05, 0.05))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/dtl_top_activated_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, eval = F}
## z-scores in bar charts
dtl_neg_pathways_merged_long_mod2 <- dtl_pathways_merged_mod2 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_neg_pathways_merged_long_mod2$name <- factor(dtl_neg_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_neg_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/dtl_top10_inhibited_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)

dtl_pos_pathways_merged_long_mod2 <- dtl_pathways_merged_mod2 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_pos_pathways_merged_long_mod2$name <- factor(dtl_pos_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_pos_pathways_merged_long_mod2
dtl_pos_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/dtl_top10_activated_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)
```

### FIB/VSMC/P

```{r echo = F}
fibvsmcp_pathways_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/fibvsmcp_DiD_pathways_2.xls", skip = 1) 
fibvsmcp_dapa_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/fibvsmcp_dapa_pathways_2.xls", skip = 1) 
fibvsmcp_croc_mod2 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/2 Zero inflation and no nested visit/fibvsmcp_croc_pathways_2.xls", skip = 1) 

colnames(fibvsmcp_pathways_mod2) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(fibvsmcp_dapa_mod2) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(fibvsmcp_croc_mod2) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

fibvsmcp_pathways_merged_mod2 <- fibvsmcp_pathways_mod2 %>%
  full_join(fibvsmcp_dapa_mod2) %>% full_join(fibvsmcp_croc_mod2) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

fibvsmcp_pathways_merged_mod2$scenario <- factor(fibvsmcp_pathways_merged_mod2$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
fibvsmcp_pathways_inhibited_mod2 <- fibvsmcp_pathways_merged_mod2 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_inhibited_mod2$pathway <- reorder(fibvsmcp_pathways_inhibited_mod2$pathway, fibvsmcp_pathways_inhibited_mod2$neg_log_p)
  
fibvsmcp_top30_inhibited_mod2 <- fibvsmcp_pathways_inhibited_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 8), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_inhibited_mod2 <- fibvsmcp_pathways_inhibited_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/fibvsmcp_top30_inhibited_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
fibvsmcp_pathways_inhibited_sig_mod2 <- fibvsmcp_pathways_inhibited_mod2 %>%
  filter(z < -2)
fibvsmcp_top30_inhibited_2_mod2 <- fibvsmcp_pathways_inhibited_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-fibvsmcp_pathways_inhibited_sig_mod2$z), max(-fibvsmcp_pathways_inhibited_sig_mod2$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.3, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/fibvsmcp_top_inhibited_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
fibvsmcp_pathways_activated_mod2 <- fibvsmcp_pathways_merged_mod2 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_activated_mod2$pathway <- reorder(fibvsmcp_pathways_activated_mod2$pathway, fibvsmcp_pathways_activated_mod2$neg_log_p)
  
fibvsmcp_top30_activated_mod2 <- fibvsmcp_pathways_activated_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 12), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_activated_mod2 <- fibvsmcp_pathways_activated_mod2 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/fibvsmcp_top30_activated_pathways_mod2_croc.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
fibvsmcp_pathways_activated_sig_mod2 <- fibvsmcp_pathways_activated_mod2 %>%
  filter(z > 2)
fibvsmcp_top30_activated_2_mod2 <- fibvsmcp_pathways_activated_sig_mod2[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(fibvsmcp_pathways_activated_sig_mod2$z), max(fibvsmcp_pathways_activated_sig_mod2$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/fibvsmcp_top_activated_pathways_2_mod2_croc.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
fibvsmcp_neg_pathways_merged_long_mod2 <- fibvsmcp_pathways_merged_mod2 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_neg_pathways_merged_long_mod2$name <- factor(fibvsmcp_neg_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_neg_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 12, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/fibvsmcp_top10_inhibited_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)

fibvsmcp_pos_pathways_merged_long_mod2 <- fibvsmcp_pathways_merged_mod2 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_pos_pathways_merged_long_mod2$name <- factor(fibvsmcp_pos_pathways_merged_long_mod2$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_pos_pathways_merged_long_mod2
fibvsmcp_pos_pathways_merged_long_mod2 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/2 Zero inflation and no nested visit/fibvsmcp_top10_activated_pathway_zscores_mod2_croc.jpeg",
       scale = 1.5)
```

# Model comparison

* Model 1: Nested visit, zero inflation

* Model 2: No nested visit, zero inflation

```{r echo = F}
## PT
pt_nc <- c(pt_nonconverged_percentage_mod1,
           pt_nonconverged_percentage_mod2)
```


```{r echo = F}
## TAL
tal_nc <- c(tal_nonconverged_percentage_mod1,
            tal_nonconverged_percentage_mod2)
```

```{r echo = F}
## PC
pc_nc <- c(pc_nonconverged_percentage_mod1,
           pc_nonconverged_percentage_mod2)
```

```{r echo = F}
## Immune
immune_nc <- c(immune_nonconverged_percentage_mod1,
               immune_nonconverged_percentage_mod2)
```

```{r echo = F}
## IC
ic_nc <- c(ic_nonconverged_percentage_mod1,
           ic_nonconverged_percentage_mod2)

```

```{r echo = F}
## EC
ec_nc <- c(ec_nonconverged_percentage_mod1,
           ec_nonconverged_percentage_mod2)
```

```{r echo = F}
## FIB/VSMC/P
fibvsmcp_nc <- c(fibvsmcp_nonconverged_percentage_mod1,
                 fibvsmcp_nonconverged_percentage_mod2)
```


```{r echo = F}
mods <- c("Model 1 (Nested Visit, ZINB)",
             "Model 2 (No nested visit, ZINB)")
mods_df <- data.frame(mods, pt_nc, tal_nc, pc_nc, immune_nc, ic_nc, ec_nc, fibvsmcp_nc)
colnames(mods_df) <- c("Model", "PT", "TAL", "PC", "Immune", "IC", "EC", "FIB, VSMC/P")
kable(mods_df, digits = 2)
```

```{r echo = F}
prefixes <- c("pt", "tal", "pc", "ic", "ec", "fibvsmcp", "immune")
mods <- paste0("mod", 1:2)

base_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/"

for (prefix in prefixes) {
  for (mod in mods) {
    obj_name <- paste0(prefix, "_nonconverged_genes_", mod)
    save_path <- file.path(base_path, paste0(obj_name, "_zi.rds"))
    saveRDS(get(obj_name), file = save_path)
  }
}
```

```{r echo = F}
sheet_list <- list()  # Store all data frames here
mods <- paste0("mod", 1:2)
for (prefix in prefixes) {
  for (mod in mods) {
    # Construct the name of the data frame (e.g., pt_emmeans_diff_DiD_mod1)
    df_name <- paste0(prefix, "_emmeans_diff_DiD_", mod)
    
    # Check if the data frame exists
    if (exists(df_name)) {
      df <- get(df_name)
      
      # Positive top 20
      pos_top20 <- df %>%
        arrange(`Expr p-value`) %>%
        filter(`Expr Other` > 0) %>%
        head(20)
      
      sheet_name_pos <- paste0(toupper(prefix), "_", mod, "_POS_Top20")
      sheet_list[[sheet_name_pos]] <- pos_top20
      
      # Negative top 20
      neg_top20 <- df %>%
        arrange((`Expr p-value`)) %>%
        filter(`Expr Other` < 0) %>%
        head(20)
      
      sheet_name_neg <- paste0(toupper(prefix), "_", mod, "_NEG_Top20")
      sheet_list[[sheet_name_neg]] <- neg_top20
    }
  }
}

# Write all to an Excel file
library(writexl)

write_xlsx(sheet_list, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/DiD_Top20_By_CellType_Mod_zi.xlsx")
```

# Overlap
# ```{r echo = F}
# gsea_bg <- c("kegg_legacy", "reactome", "go")
# prefixes <- c("pt", "tal", "pc", "ic", "ec", "fibvsmcp", "immune")
# mod12 <- c("mod1", "mod2")
# # Loop through gsea backgrounds and combine results
# combined_results <- list()
# 
# for (bg in gsea_bg) {
#   temp_list <- list()
#   
#   for (prefix in prefixes) {
#     for (mod in mod12) {
#       df_name <- paste0(bg, "_res_", prefix, "_", mod)
#       
#       if (exists(df_name)) {
#         df <- get(df_name)
#         
#         # Add metadata columns for tracking
#         df$prefix <- prefix
#         df$mod <- mod
#         
#         temp_list[[df_name]] <- df
#       }
#     }
#   }
#   
#   # Combine all data frames for the current gsea background
#   combined_results[[bg]] <- bind_rows(temp_list)
# }
# 
# kegg_legacy_all <- combined_results[["kegg_legacy"]]
# reactome_all    <- combined_results[["reactome"]]
# go_all          <- combined_results[["go"]]
# ```
# 
# ## KEGG
# 
# ```{r echo = F}
# # model 1 GSEA significant (p < 0.05) overlap
# kegg_matrix_mod1 <- kegg_legacy_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod1") %>%
#   dplyr::select(pathway, prefix) %>%
#   distinct() %>%
#   mutate(present = 1) %>%
#   pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
# upset(kegg_matrix_mod1, 
#       intersect = prefixes,
#       name = "Significant Pathway Presence",
#       base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
#       width_ratio = 0.15)
# 
# common_pathways_kegg_mod1 <- kegg_legacy_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod1") %>%
#   group_by(pathway) %>%
#   summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
#   filter(n_prefixes > 1) %>% 
#   arrange(desc(n_prefixes))
# common_pathways_kegg_mod1 <- common_pathways_kegg_mod1 %>%
#   left_join(kegg_matrix_mod1) %>%
#   rowwise() %>%
#   mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
#   ungroup()
# 
# # model 2 GSEA significant (p < 0.05) overlap
# kegg_matrix_mod2 <- kegg_legacy_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod2") %>%
#   dplyr::select(pathway, prefix) %>%
#   distinct() %>%
#   mutate(present = 1) %>%
#   pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
# upset(kegg_matrix_mod2, 
#       intersect = prefixes,
#       name = "Significant Pathway Presence",
#       base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
#       width_ratio = 0.15)
# 
# common_pathways_kegg_mod2 <- kegg_legacy_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod2") %>%
#   group_by(pathway) %>%
#   summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
#   filter(n_prefixes > 1) %>% 
#   arrange(desc(n_prefixes))
# common_pathways_kegg_mod2 <- common_pathways_kegg_mod2 %>%
#   left_join(kegg_matrix_mod2) %>%
#   rowwise() %>%
#   mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
#   ungroup()
# ```
# ## REACTOME
# 
# ```{r echo = F}
# # model 1 GSEA significant (p < 0.05) overlap
# reactome_matrix_mod1 <- reactome_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod1") %>%
#   dplyr::select(pathway, prefix) %>%
#   distinct() %>%
#   mutate(present = 1) %>%
#   pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
# upset(reactome_matrix_mod1, 
#       intersect = prefixes,
#       name = "Significant Pathway Presence",
#       base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
#       width_ratio = 0.15)
# 
# common_pathways_reactome_mod1 <- reactome_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod1") %>%
#   group_by(pathway) %>%
#   summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
#   filter(n_prefixes > 1) %>% 
#   arrange(desc(n_prefixes))
# common_pathways_reactome_mod1 <- common_pathways_reactome_mod1 %>%
#   left_join(reactome_matrix_mod1) %>%
#   rowwise() %>%
#   mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
#   ungroup()
# 
# # model 2 GSEA significant (p < 0.05) overlap
# reactome_matrix_mod2 <- reactome_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod2") %>%
#   dplyr::select(pathway, prefix) %>%
#   distinct() %>%
#   mutate(present = 1) %>%
#   pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
# upset(reactome_matrix_mod2, 
#       intersect = prefixes,
#       name = "Significant Pathway Presence",
#       base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
#       width_ratio = 0.15)
# 
# common_pathways_reactome_mod2 <- reactome_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod2") %>%
#   group_by(pathway) %>%
#   summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
#   filter(n_prefixes > 1) %>% 
#   arrange(desc(n_prefixes))
# common_pathways_reactome_mod2 <- common_pathways_reactome_mod2 %>%
#   left_join(reactome_matrix_mod2) %>%
#   rowwise() %>%
#   mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
#   ungroup()
# ```
# 
# ## GO
# 
# ```{r echo = F}
# # model 1 GSEA significant (p < 0.05) overlap
# go_matrix_mod1 <- go_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod1") %>%
#   dplyr::select(pathway, prefix) %>%
#   distinct() %>%
#   mutate(present = 1) %>%
#   pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
# upset(go_matrix_mod1, 
#       intersect = prefixes,
#       name = "Significant Pathway Presence",
#       base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
#       width_ratio = 0.15)
# 
# common_pathways_go_mod1 <- go_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod1") %>%
#   group_by(pathway) %>%
#   summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
#   filter(n_prefixes > 1) %>% 
#   arrange(desc(n_prefixes))
# common_pathways_go_mod1 <- common_pathways_go_mod1 %>%
#   left_join(go_matrix_mod1) %>%
#   rowwise() %>%
#   mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
#   ungroup()
# 
# # model 2 GSEA significant (p < 0.05) overlap
# go_matrix_mod2 <- go_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod2") %>%
#   dplyr::select(pathway, prefix) %>%
#   distinct() %>%
#   mutate(present = 1) %>%
#   pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
# upset(go_matrix_mod2, 
#       intersect = prefixes,
#       name = "Significant Pathway Presence",
#       base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
#       width_ratio = 0.15)
# 
# common_pathways_go_mod2 <- go_all %>%
#   filter(pval < 0.05) %>%
#   filter(mod == "mod2") %>%
#   group_by(pathway) %>%
#   summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
#   filter(n_prefixes > 1) %>% 
#   arrange(desc(n_prefixes))
# common_pathways_go_mod2 <- common_pathways_go_mod2 %>%
#   left_join(go_matrix_mod2) %>%
#   rowwise() %>%
#   mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
#   ungroup()
# ```
# 
# 
# 
# ## Rerun figures for GSEA (fgsea) with overlap information
# ### Model 1
# #### PT
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_pt_mod1_overlap <- kegg_legacy_res_pt_mod1 %>%
#   left_join(common_pathways_kegg_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(kegg_legacy_res_pt_mod1_overlap, title = "Model 1 PT Top 30 KEGG", xnudge = 0.03)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/pt_top30_kegg_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_pt_mod1_overlap <- reactome_res_pt_mod1 %>%
#   left_join(common_pathways_reactome_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(reactome_res_pt_mod1_overlap, title = "Model 1 PT Top 30 REACTOME", xmax = 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/pt_top30_reactome_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### GO
# ```{r echo = F}
# go_res_pt_mod1_overlap <- go_res_pt_mod1 %>%
#   left_join(common_pathways_go_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(go_res_pt_mod1_overlap, title = "Model 1 PT Top 30 GO", xmax = 8)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/pt_top30_go_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# #### TAL
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_tal_mod1_overlap <- kegg_legacy_res_tal_mod1 %>%
#   left_join(common_pathways_kegg_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(kegg_legacy_res_tal_mod1_overlap, title = "Model 1 TAL Top 30 KEGG", xlim= 4)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/tal_top30_kegg_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_tal_mod1_overlap <- reactome_res_tal_mod1 %>%
#   left_join(common_pathways_reactome_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(reactome_res_tal_mod1_overlap, title = "Model 1 TAL Top 30 REACTOME", xmax = 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/tal_top30_reactome_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_tal_mod1_overlap <- go_res_tal_mod1 %>%
#   left_join(common_pathways_go_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(go_res_tal_mod1_overlap, title = "Model 1 TAL Top 30 GO", xmax = 6)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/tal_top30_go_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# 
# ### PC
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_pc_mod1_overlap <- kegg_legacy_res_pc_mod1 %>%
#   left_join(common_pathways_kegg_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(kegg_legacy_res_pc_mod1_overlap, title = "Model 1 PC Top 30 KEGG", xlim= 3)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/pc_top30_kegg_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_pc_mod1_overlap <- reactome_res_pc_mod1 %>%
#   left_join(common_pathways_reactome_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(reactome_res_pc_mod1_overlap, title = "Model 1 PC Top 30 REACTOME", xmax = 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/pc_top30_reactome_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_pc_mod1_overlap <- go_res_pc_mod1 %>%
#   left_join(common_pathways_go_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(go_res_pc_mod1_overlap, title = "Model 1 PC Top 30 GO", xmax = 8)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/pc_top30_go_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ### Immune (very few cells)
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_immune_mod1_overlap <- kegg_legacy_res_immune_mod1 %>%
#   left_join(common_pathways_kegg_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(kegg_legacy_res_immune_mod1_overlap, title = "Model 1 Immune Top 30 KEGG", xlim= 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/immune_top30_kegg_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_immune_mod1_overlap <- reactome_res_immune_mod1 %>%
#   left_join(common_pathways_reactome_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(reactome_res_immune_mod1_overlap, title = "Model 1 Immune Top 30 REACTOME", xmax = 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/immune_top30_reactome_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_immune_mod1_overlap <- go_res_immune_mod1 %>%
#   left_join(common_pathways_go_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(go_res_immune_mod1_overlap, title = "Model 1 Immune Top 30 GO", xmax = 7)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/immune_top30_go_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ### IC
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_ic_mod1_overlap <- kegg_legacy_res_ic_mod1 %>%
#   left_join(common_pathways_kegg_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(kegg_legacy_res_ic_mod1_overlap, title = "Model 1 IC Top 30 KEGG", xlim= 4)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/ic_top30_kegg_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_ic_mod1_overlap <- reactome_res_ic_mod1 %>%
#   left_join(common_pathways_reactome_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(reactome_res_ic_mod1_overlap, title = "Model 1 IC Top 30 REACTOME", xmax = 8)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/ic_top30_reactome_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_ic_mod1_overlap <- go_res_ic_mod1 %>%
#   left_join(common_pathways_go_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(go_res_ic_mod1_overlap, title = "Model 1 IC Top 30 GO", xmax = 8)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/ic_top30_go_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ### EC
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_ec_mod1_overlap <- kegg_legacy_res_ec_mod1 %>%
#   left_join(common_pathways_kegg_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(kegg_legacy_res_ec_mod1_overlap, title = "Model 1 EC Top 30 KEGG", xlim= 4)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/ec_top30_kegg_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_ec_mod1_overlap <- reactome_res_ec_mod1 %>%
#   left_join(common_pathways_reactome_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(reactome_res_ec_mod1_overlap, title = "Model 1 EC Top 30 REACTOME", xmax = 4)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/ec_top30_reactome_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_ec_mod1_overlap <- go_res_ec_mod1 %>%
#   left_join(common_pathways_go_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(go_res_ec_mod1_overlap, title = "Model 1 EC Top 30 GO", xmax = 7)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/ec_top30_go_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ### FIB/VSMC/P
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_fibvsmcp_mod1_overlap <- kegg_legacy_res_fibvsmcp_mod1 %>%
#   left_join(common_pathways_kegg_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(kegg_legacy_res_fibvsmcp_mod1_overlap, title = "Model 1 FIB/VSMC/P Top 30 KEGG", xlim= 3)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/fibvsmcp_top30_kegg_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_fibvsmcp_mod1_overlap <- reactome_res_fibvsmcp_mod1 %>%
#   left_join(common_pathways_reactome_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(reactome_res_fibvsmcp_mod1_overlap, title = "Model 1 FIB/VSMC/P Top 30 REACTOME", xmax = 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/fibvsmcp_top30_reactome_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_fibvsmcp_mod1_overlap <- go_res_fibvsmcp_mod1 %>%
#   left_join(common_pathways_go_mod1) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(go_res_fibvsmcp_mod1_overlap, title = "Model 1 FIB/VSMC/P Top 30 GO", xmax = 6)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/gsea/fibvsmcp_top30_go_pathways_mod1_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ### model 2
# #### PT
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_pt_mod2_overlap <- kegg_legacy_res_pt_mod2 %>%
#   left_join(common_pathways_kegg_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(kegg_legacy_res_pt_mod2_overlap, title = "model 2 PT Top 30 KEGG", xlim= 3)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/pt_top30_kegg_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_pt_mod2_overlap <- reactome_res_pt_mod2 %>%
#   left_join(common_pathways_reactome_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(reactome_res_pt_mod2_overlap, title = "model 2 PT Top 30 REACTOME", xmax = 6)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/pt_top30_reactome_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_pt_mod2_overlap <- go_res_pt_mod2 %>%
#   left_join(common_pathways_go_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(go_res_pt_mod2_overlap, title = "model 2 PT Top 30 GO", xmax = 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/pt_top30_go_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ### TAL
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_tal_mod2_overlap <- kegg_legacy_res_tal_mod2 %>%
#   left_join(common_pathways_kegg_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(kegg_legacy_res_tal_mod2_overlap, title = "model 2 TAL Top 30 KEGG", xlim= 3)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/tal_top30_kegg_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_tal_mod2_overlap <- reactome_res_tal_mod2 %>%
#   left_join(common_pathways_reactome_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(reactome_res_tal_mod2_overlap, title = "model 2 TAL Top 30 REACTOME", xmax = 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/tal_top30_reactome_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_tal_mod2_overlap <- go_res_tal_mod2 %>%
#   left_join(common_pathways_go_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(go_res_tal_mod2_overlap, title = "model 2 TAL Top 30 GO", xmax = 7)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/tal_top30_go_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ### PC
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_pc_mod2_overlap <- kegg_legacy_res_pc_mod2 %>%
#   left_join(common_pathways_kegg_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(kegg_legacy_res_pc_mod2_overlap, title = "model 2 PC Top 30 KEGG", xlim= 3)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/pc_top30_kegg_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_pc_mod2_overlap <- reactome_res_pc_mod2 %>%
#   left_join(common_pathways_reactome_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(reactome_res_pc_mod2_overlap, title = "model 2 PC Top 30 REACTOME", xmax = 4)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/pc_top30_reactome_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_pc_mod2_overlap <- go_res_pc_mod2 %>%
#   left_join(common_pathways_go_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(go_res_pc_mod2_overlap, title = "model 2 PC Top 30 GO", xmax = 8)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/pc_top30_go_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ### Immune (very few cells)
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_immune_mod2_overlap <- kegg_legacy_res_immune_mod2 %>%
#   left_join(common_pathways_kegg_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(kegg_legacy_res_immune_mod2_overlap, title = "model 2 Immune Top 30 KEGG", xlim= 4)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/immune_top30_kegg_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_immune_mod2_overlap <- reactome_res_immune_mod2 %>%
#   left_join(common_pathways_reactome_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(reactome_res_immune_mod2_overlap, title = "model 2 Immune Top 30 REACTOME", xmax = 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/immune_top30_reactome_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_immune_mod2_overlap <- go_res_immune_mod2 %>%
#   left_join(common_pathways_go_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(go_res_immune_mod2_overlap, title = "model 2 Immune Top 30 GO", xmax = 8)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/immune_top30_go_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ### IC
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_ic_mod2_overlap <- kegg_legacy_res_ic_mod2 %>%
#   left_join(common_pathways_kegg_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(kegg_legacy_res_ic_mod2_overlap, title = "model 2 IC Top 30 KEGG", xlim= 4)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/ic_top30_kegg_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_ic_mod2_overlap <- reactome_res_ic_mod2 %>%
#   left_join(common_pathways_reactome_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(reactome_res_ic_mod2_overlap, title = "model 2 IC Top 30 REACTOME", xmax = 8)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/ic_top30_reactome_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_ic_mod2_overlap <- go_res_ic_mod2 %>%
#   left_join(common_pathways_go_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(go_res_ic_mod2_overlap, title = "model 2 IC Top 30 GO", xmax = 8)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/ic_top30_go_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# 
# ### EC
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_ec_mod2_overlap <- kegg_legacy_res_ec_mod2 %>%
#   left_join(common_pathways_kegg_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(kegg_legacy_res_ec_mod2_overlap, title = "model 2 EC Top 30 KEGG", xlim= 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/ec_top30_kegg_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_ec_mod2_overlap <- reactome_res_ec_mod2 %>%
#   left_join(common_pathways_reactome_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(reactome_res_ec_mod2_overlap, title = "model 2 EC Top 30 REACTOME", xmax = 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/ec_top30_reactome_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_ec_mod2_overlap <- go_res_ec_mod2 %>%
#   left_join(common_pathways_go_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(go_res_ec_mod2_overlap, title = "model 2 EC Top 30 GO", xmax = 7)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/ec_top30_go_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# 
# ### FIB/VSMC/P
# ##### KEGG Legacy
# ```{r echo = F}
# kegg_legacy_res_fibvsmcp_mod2_overlap <- kegg_legacy_res_fibvsmcp_mod2 %>%
#   left_join(common_pathways_kegg_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# 
# plot_fgsea(kegg_legacy_res_fibvsmcp_mod2_overlap, title = "model 2 FIB/VSMC/P Top 30 KEGG", xlim= 3)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/fibvsmcp_top30_kegg_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# 
# ##### REACTOME
# ```{r echo = F}
# reactome_res_fibvsmcp_mod2_overlap <- reactome_res_fibvsmcp_mod2 %>%
#   left_join(common_pathways_reactome_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(reactome_res_fibvsmcp_mod2_overlap, title = "model 2 FIB/VSMC/P Top 30 REACTOME", xmax = 5)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/fibvsmcp_top30_reactome_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```
# ##### GO
# ```{r echo = F}
# go_res_fibvsmcp_mod2_overlap <- go_res_fibvsmcp_mod2 %>%
#   left_join(common_pathways_go_mod2) %>%
#   mutate(face = case_when(is.na(n_prefixes) ~ "plain",
#                           T ~ "bold"),
#          pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
#                              T~ pathway))
# plot_fgsea(go_res_fibvsmcp_mod2_overlap, title = "model 2 FIB/VSMC/P Top 30 GO", xmax = 8)
# 
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/2 Zero inflation and no nested visit/gsea/fibvsmcp_top30_go_pathways_mod2_croc.jpeg",
#        width = 27.5, height = 14, scale = 1)
# ```

